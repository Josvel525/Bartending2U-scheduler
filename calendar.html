<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Calendar - Bartending2U</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="styles.css" />
</head>
<body>
    <header class="top-bar">
        <div class="top-bar__inner">
            <div class="brand">
                <img src="IMG_9047.png" alt="Bartending2U logo" />
                <div class="brand__text">
                    <span class="brand__subtitle">Bartending2U</span>
                    <span class="brand__title">Scheduling Suite</span>
                </div>
            </div>

            <button class="mobile-nav-toggle" id="mobileNavToggle" aria-label="Toggle navigation">☰</button>

            <nav class="nav-links" id="primaryNav">
                <a class="nav-link" href="index.html">Dashboard</a>
                <a class="nav-link" href="events.html">Events</a>
                <a class="nav-link" href="employees.html">Employees</a>
                <a class="nav-link active" href="calendar.html">Calendar</a>
                <a class="nav-link" href="settings.html">Settings</a>
            </nav>

            <a class="cta-button" href="events.html">+ New Event</a>
        </div>
    </header>

    <main class="page-content">
        <section class="page-header">
            <div>
                <p class="page-eyebrow">Calendar</p>
                <h1 class="page-title">Plan every pour & prep</h1>
                <p class="lead-text">Visualize your bookings, staffing, and prep milestones across the month. Drag-and-drop coming soon.</p>
            </div>
            <div class="hero-actions">
                <a class="button primary" href="events.html">Review events</a>
                <a class="secondary-link" href="settings.html">Calendar settings →</a>
            </div>
        </section>

        <section class="content-card">
            <div class="card-header">
                <div>
                    <h2 class="card-title" id="calendarMonthHeading">Monthly overview</h2>
                    <p class="card-subtitle">Hover over a day to reveal assignments and prep checklists.</p>
                </div>
            </div>
            <div class="calendar-grid" id="calendarGrid"></div>
        </section>

        <section class="split-layout">
            <article class="content-card">
                <div class="card-header">
                    <div>
                        <h2 class="card-title">Prep checklist</h2>
                        <p class="card-subtitle">Ensure every garnish, glass, and batch is ready ahead of time.</p>
                    </div>
                </div>
                <div class="preferences-list">
                    <label class="checkbox-field"><input type="checkbox" checked /> Confirm rental deliveries</label>
                    <label class="checkbox-field"><input type="checkbox" /> Send staff arrival reminders</label>
                    <label class="checkbox-field"><input type="checkbox" checked /> Prep signature syrups</label>
                    <label class="checkbox-field"><input type="checkbox" /> Load ingredient crates</label>
                </div>
            </article>

            <article class="content-card">
                <div class="card-header">
                    <div>
                        <h2 class="card-title">Week at a glance</h2>
                        <p class="card-subtitle">Quick summary of guests, staffing, and prep hours.</p>
                    </div>
                </div>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>Event</th>
                                <th>Guests</th>
                                <th>Team</th>
                                <th>Prep hours</th>
                            </tr>
                        </thead>
                        <tbody id="weekSummaryTable"></tbody>
                    </table>
                </div>
            </article>
        </section>
    </main>

    <footer class="app-footer">© 2025 Bartending2U. Crafted for seamless event coordination.</footer>

    <script src="storage.js"></script>
    <script>
        const navToggle = document.getElementById('mobileNavToggle');
        const nav = document.getElementById('primaryNav');

        if (navToggle && nav) {
            navToggle.addEventListener('click', () => {
                nav.classList.toggle('open');
            });
        }

        const store = window.B2UStore;
        const calendarGrid = document.getElementById('calendarGrid');
        const calendarHeading = document.getElementById('calendarMonthHeading');
        const weekSummaryTable = document.getElementById('weekSummaryTable');

        const weekdayFormatter = new Intl.DateTimeFormat('en-US', { weekday: 'short' });
        const monthFormatter = new Intl.DateTimeFormat('en-US', { month: 'long', year: 'numeric' });

        function getEventTimestamp(event) {
            if (!event || !event.date) {
                return Number.MAX_SAFE_INTEGER;
            }

            const timestamp = new Date(`${event.date}T${event.time || '00:00'}`).getTime();
            return Number.isNaN(timestamp) ? Number.MAX_SAFE_INTEGER : timestamp;
        }

        function renderCalendar(events) {
            if (!calendarGrid) {
                return;
            }

            calendarGrid.innerHTML = '';

            if (!store) {
                const message = document.createElement('p');
                message.className = 'empty-state';
                message.textContent = 'Calendar data unavailable. Refresh to retry.';
                calendarGrid.appendChild(message);
                return;
            }

            const today = new Date();
            const sorted = events.slice().sort((a, b) => getEventTimestamp(a) - getEventTimestamp(b));
            const firstUpcoming = sorted.find((event) => getEventTimestamp(event) !== Number.MAX_SAFE_INTEGER);
            const referenceDate = firstUpcoming && firstUpcoming.date ? new Date(`${firstUpcoming.date}T00:00`) : today;

            const year = referenceDate.getFullYear();
            const month = referenceDate.getMonth();
            const monthStart = new Date(year, month, 1);
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const leadingEmpty = monthStart.getDay();

            if (calendarHeading) {
                calendarHeading.textContent = `${monthFormatter.format(referenceDate)} overview`;
            }

            const eventsByDate = events.reduce((acc, event) => {
                if (!event.date) {
                    return acc;
                }
                (acc[event.date] = acc[event.date] || []).push(event);
                return acc;
            }, {});

            for (let i = 0; i < leadingEmpty; i += 1) {
                const emptyCell = document.createElement('div');
                emptyCell.className = 'calendar-cell calendar-cell--empty';
                calendarGrid.appendChild(emptyCell);
            }

            for (let day = 1; day <= daysInMonth; day += 1) {
                const cellDate = new Date(year, month, day);
                const isoDate = cellDate.toISOString().slice(0, 10);
                const cell = document.createElement('div');
                cell.className = 'calendar-cell';

                if (cellDate.toDateString() === today.toDateString()) {
                    cell.classList.add('calendar-cell--today');
                }

                const dateLabel = document.createElement('span');
                dateLabel.className = 'calendar-cell__date';
                dateLabel.textContent = `${weekdayFormatter.format(cellDate)} ${day}`;
                cell.appendChild(dateLabel);

                const dayEvents = eventsByDate[isoDate] || [];
                dayEvents
                    .slice()
                    .sort((a, b) => getEventTimestamp(a) - getEventTimestamp(b))
                    .forEach((event) => {
                        const eventBlock = document.createElement('div');
                        eventBlock.className = 'calendar-event';
                        eventBlock.textContent = event.name;
                        cell.appendChild(eventBlock);

                        const details = document.createElement('p');
                        details.className = 'card-subtitle';
                        const time = event.time ? ` · ${event.time}` : '';
                        const location = event.location ? ` · ${event.location}` : '';
                        details.textContent = `${event.staffingStatus || 'Staffing pending'}${time}${location}`;
                        cell.appendChild(details);
                    });

                calendarGrid.appendChild(cell);
            }
        }

        function estimatePrepHours(event) {
            if (!event) {
                return 0;
            }

            const guests = event.guestCount || 0;
            const base = guests ? Math.max(2, Math.ceil(guests / 40)) : 3;
            return event.staffingLevel === 'success' ? base : base + 1;
        }

        function renderWeekSummary(events) {
            if (!weekSummaryTable) {
                return;
            }

            weekSummaryTable.innerHTML = '';

            if (!store) {
                const row = document.createElement('tr');
                const cell = document.createElement('td');
                cell.colSpan = 4;
                cell.className = 'empty-state';
                cell.textContent = 'Unable to load weekly summary.';
                row.appendChild(cell);
                weekSummaryTable.appendChild(row);
                return;
            }

            const now = Date.now();
            const oneWeek = 1000 * 60 * 60 * 24 * 7;
            const upcomingWeek = events
                .slice()
                .sort((a, b) => getEventTimestamp(a) - getEventTimestamp(b))
                .filter((event) => {
                    const timestamp = getEventTimestamp(event);
                    return timestamp >= now && timestamp <= now + oneWeek;
                })
                .slice(0, 6);

            if (upcomingWeek.length === 0) {
                const row = document.createElement('tr');
                const cell = document.createElement('td');
                cell.colSpan = 4;
                cell.className = 'empty-state';
                cell.textContent = 'Nothing booked for the next seven days.';
                row.appendChild(cell);
                weekSummaryTable.appendChild(row);
                return;
            }

            upcomingWeek.forEach((event) => {
                const row = document.createElement('tr');

                const nameCell = document.createElement('td');
                nameCell.textContent = event.name;

                const guestCell = document.createElement('td');
                guestCell.textContent = event.guestCount ? event.guestCount : '—';

                const teamCell = document.createElement('td');
                teamCell.textContent = event.staffingStatus || 'Staffing pending';

                const prepCell = document.createElement('td');
                prepCell.textContent = estimatePrepHours(event);

                row.appendChild(nameCell);
                row.appendChild(guestCell);
                row.appendChild(teamCell);
                row.appendChild(prepCell);
                weekSummaryTable.appendChild(row);
            });
        }

        function renderCalendarPage() {
            if (!store) {
                renderCalendar([]);
                renderWeekSummary([]);
                return;
            }

            const events = store.getEvents();
            renderCalendar(events);
            renderWeekSummary(events);
        }

        renderCalendarPage();
    </script>
</body>
</html>
