<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Calendar - Bartending2U</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="styles.css" />
</head>
<body>
    <header class="top-bar">
        <div class="top-bar__inner">
            <div class="brand">
                <img src="IMG_9047.png" alt="Bartending2U logo" />
                <div class="brand__text">
                    <span class="brand__subtitle">Bartending2U</span>
                    <span class="brand__title">Scheduling Suite</span>
                </div>
            </div>

            <button
                class="mobile-nav-toggle"
                id="mobileNavToggle"
                type="button"
                aria-label="Toggle navigation"
                aria-expanded="false"
                data-mobile-nav-toggle
            >
                <span class="mobile-nav-toggle__icon" aria-hidden="true">☰</span>
                <span class="sr-only">Toggle navigation</span>
            </button>

            <nav class="nav-links" id="primaryNav">
                <a class="nav-link" href="index.html">Dashboard</a>
                <a class="nav-link" href="events.html">Events</a>
                <a class="nav-link" href="leads.html">Leads</a>
                <a class="nav-link" href="employees.html">Employees</a>
                <a class="nav-link active" href="calendar.html">Calendar</a>
                <a class="nav-link" href="settings.html">Settings</a>
            </nav>

            <a class="cta-button" href="events.html">+ New Event</a>
        </div>
    </header>

    <main class="page-content">
        <section class="page-header">
            <div>
                <p class="page-eyebrow">Calendar</p>
                <h1 class="page-title">Plan your month</h1>
                <p class="lead-text">See bookings, staffing, and prep tasks for the month. Drag-and-drop coming soon.</p>
            </div>
            <div class="hero-actions">
                <a class="button primary" href="events.html">Review events</a>
                <a class="secondary-link" href="settings.html">Calendar settings →</a>
            </div>
        </section>

        <section id="calendar-overview" class="content-card" data-subsection="Monthly overview">
            <div class="card-header">
                <div>
                    <h2 class="card-title" id="calendarMonthHeading">This month</h2>
                    <p class="card-subtitle">Select a day to view its events and staffing.</p>
                </div>
            </div>
            <div class="calendar-layout">
                <div class="calendar-month">
                    <div class="calendar-controls" aria-controls="calendarGrid">
                        <button class="calendar-controls__button" type="button" data-calendar-nav="prev" aria-label="Previous month">
                            ‹
                        </button>
                        <div class="calendar-controls__label">
                            <span class="calendar-controls__heading" id="calendarControlsLabel">October 2025</span>
                            <button class="calendar-controls__link" type="button" data-calendar-nav="today">Jump to today</button>
                        </div>
                        <button class="calendar-controls__button" type="button" data-calendar-nav="next" aria-label="Next month">
                            ›
                        </button>
                    </div>
                    <div class="calendar-weekdays" aria-hidden="true">
                        <span>Sun</span>
                        <span>Mon</span>
                        <span>Tue</span>
                        <span>Wed</span>
                        <span>Thu</span>
                        <span>Fri</span>
                        <span>Sat</span>
                    </div>
                    <div class="calendar-grid" id="calendarGrid" role="grid" aria-labelledby="calendarControlsLabel"></div>
                </div>
                <aside class="calendar-detail" id="calendarDayDetails" aria-live="polite">
                    <h3 class="calendar-detail__title" id="calendarSelectedHeading">Today</h3>
                    <p class="calendar-detail__subtitle" id="calendarSelectedSummary">No events yet.</p>
                    <div class="calendar-detail__list" id="calendarDayList"></div>
                </aside>
            </div>
        </section>

        <section class="split-layout">
            <article id="prep-checklist" class="content-card" data-subsection="Prep checklist">
                <div class="card-header">
                    <div>
                        <h2 class="card-title">Prep checklist</h2>
                        <p class="card-subtitle">Tick off supplies and reminders before wheels up.</p>
                    </div>
                </div>
                <div class="preferences-list">
                    <label class="checkbox-field"><input type="checkbox" checked /> Confirm rental deliveries</label>
                    <label class="checkbox-field"><input type="checkbox" /> Send staff arrival reminders</label>
                    <label class="checkbox-field"><input type="checkbox" checked /> Prep signature syrups</label>
                    <label class="checkbox-field"><input type="checkbox" /> Load ingredient crates</label>
                </div>
            </article>

            <article id="week-glance" class="content-card" data-subsection="Week at a glance">
                <div class="card-header">
                    <div>
                        <h2 class="card-title">This week</h2>
                        <p class="card-subtitle">Quick view of guests, staffing, and prep hours.</p>
                    </div>
                </div>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>Event</th>
                                <th>Date</th>
                                <th>Guests</th>
                                <th>Team</th>
                                <th>Prep hours</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td data-label="Event">Corporate Party</td>
                                <td data-label="Date">Oct 12</td>
                                <td data-label="Guests">120</td>
                                <td data-label="Team">4</td>
                                <td data-label="Prep hours">6</td>
                            </tr>
                            <tr>
                                <td data-label="Event">Wedding Reception</td>
                                <td data-label="Date">Oct 14</td>
                                <td data-label="Guests">180</td>
                                <td data-label="Team">Pending</td>
                                <td data-label="Prep hours">8</td>
                            </tr>
                            <tr>
                                <td data-label="Event">Mixology Workshop</td>
                                <td data-label="Date">Oct 16</td>
                                <td data-label="Guests">25</td>
                                <td data-label="Team">2</td>
                                <td data-label="Prep hours">3</td>
                            </tr>
                        </tbody>
                        <tbody id="weekSummaryTable"></tbody>
                    </table>
                </div>
            </article>
        </section>
    </main>

    <footer class="app-footer">© 2025 Bartending2U. Crafted for seamless event coordination.</footer>

    <script src="scripts.js"></script>
    <script src="storage.js"></script>
    <script>
        const navToggle = document.getElementById('mobileNavToggle');
        const nav = document.getElementById('primaryNav');

        if (navToggle && nav) {
            navToggle.addEventListener('click', () => {
                nav.classList.toggle('open');
            });
        }

        const store = window.B2UStore;
        const calendarGrid = document.getElementById('calendarGrid');
        const calendarHeading = document.getElementById('calendarMonthHeading');
        const calendarControlsLabel = document.getElementById('calendarControlsLabel');
        const calendarDayList = document.getElementById('calendarDayList');
        const calendarSelectedHeading = document.getElementById('calendarSelectedHeading');
        const calendarSelectedSummary = document.getElementById('calendarSelectedSummary');
        const weekSummaryTable = document.getElementById('weekSummaryTable');
        const navButtons = document.querySelectorAll('[data-calendar-nav]');

        const weekdayFormatter = new Intl.DateTimeFormat('en-US', { weekday: 'short' });
        const dateFormatter = new Intl.DateTimeFormat('en-US', { month: 'short', day: 'numeric' });
        const monthFormatter = new Intl.DateTimeFormat('en-US', { month: 'long', year: 'numeric' });
        const weekdayFormatter = new Intl.DateTimeFormat('en-US', { weekday: 'short' });
        const dayFormatter = new Intl.DateTimeFormat('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
        const timeFormatter = new Intl.DateTimeFormat('en-US', { hour: 'numeric', minute: '2-digit' });

        const today = new Date();

        const state = {
            events: [],
            employees: [],
            employeeMap: new Map(),
            currentMonth: new Date(today.getFullYear(), today.getMonth(), 1),
            selectedDate: new Date(today.getFullYear(), today.getMonth(), today.getDate()),
        };

        function buildEmployeeIndex() {
            state.employeeMap.clear();
            state.employees.forEach((employee) => {
                state.employeeMap.set(employee.id, employee);
            });
        }

        function toISODate(date) {
            if (!(date instanceof Date) || Number.isNaN(date.getTime())) {
                return '';
            }
            return date.toISOString().slice(0, 10);
        }

        function formatEventDate(dateString) {
            if (!dateString) {
                return '—';
            }

            const parts = dateString.split('-').map(Number);

            if (parts.length !== 3 || parts.some((value) => Number.isNaN(value))) {
                return '—';
            }

            const [year, month, day] = parts;
            const eventDate = new Date(year, month - 1, day);

            if (Number.isNaN(eventDate.getTime())) {
                return '—';
            }

            return dateFormatter.format(eventDate);
        }

        function getEventTimestamp(event) {
            if (!event || !event.date) {
                return Number.MAX_SAFE_INTEGER;
            }

            const timestamp = new Date(`${event.date}T${event.time || '00:00'}`).getTime();
            return Number.isNaN(timestamp) ? Number.MAX_SAFE_INTEGER : timestamp;
        }

        function getStaffNames(ids) {
            if (!Array.isArray(ids) || ids.length === 0) {
                return [];
            }

            return ids
                .map((id) => state.employeeMap.get(id))
                .filter(Boolean)
                .map((employee) => employee.name);
        }

        function getEventsByDate() {
            const grouped = new Map();

            state.events.forEach((event) => {
                if (!event.date) {
                    return;
                }

                const list = grouped.get(event.date) || [];
                list.push(event);
                grouped.set(event.date, list);
            });

            grouped.forEach((list, key) => {
                list.sort((a, b) => getEventTimestamp(a) - getEventTimestamp(b));
                grouped.set(key, list);
            });

            return grouped;
        }

        function formatEventTime(event) {
            if (!event || !event.time) {
                return 'Time TBC';
            }

            const date = new Date(`${event.date}T${event.time}`);
            if (Number.isNaN(date.getTime())) {
                return 'Time TBC';
            }

            return timeFormatter.format(date);
        }

        function renderCalendar() {
            if (!calendarGrid) {
                return;
            }

            calendarGrid.innerHTML = '';

            if (!store) {
                const message = document.createElement('p');
                message.className = 'empty-state';
                message.textContent = 'Calendar data unavailable. Refresh to retry.';
                calendarGrid.appendChild(message);
                return;
            }

            const eventsByDate = getEventsByDate();
            const monthStart = new Date(state.currentMonth.getFullYear(), state.currentMonth.getMonth(), 1);
            const startDay = monthStart.getDay();
            const daysInMonth = new Date(state.currentMonth.getFullYear(), state.currentMonth.getMonth() + 1, 0).getDate();
            const totalCells = Math.ceil((startDay + daysInMonth) / 7) * 7;
            const headingText = monthFormatter.format(state.currentMonth);
            const selectedIso = toISODate(state.selectedDate);
            const todayIso = toISODate(today);

            if (calendarHeading) {
                calendarHeading.textContent = headingText;
            }
            if (calendarControlsLabel) {
                calendarControlsLabel.textContent = headingText;
            }

            for (let index = 0; index < totalCells; index += 1) {
                const cellDate = new Date(monthStart);
                cellDate.setDate(cellDate.getDate() - startDay + index);
                const isoDate = toISODate(cellDate);
                const cell = document.createElement('div');
                cell.className = 'calendar-cell';
                cell.setAttribute('role', 'gridcell');

                if (cellDate.getMonth() !== state.currentMonth.getMonth()) {
                    cell.classList.add('calendar-cell--muted');
                    cell.setAttribute('aria-disabled', 'true');
                    cell.tabIndex = -1;
                } else {
                    cell.tabIndex = 0;
                }

                if (isoDate === todayIso) {
                    cell.classList.add('calendar-cell--today');
                }

                if (isoDate === selectedIso) {
                    cell.classList.add('calendar-cell--selected');
                    cell.setAttribute('aria-selected', 'true');
                } else {
                    cell.setAttribute('aria-selected', 'false');
                }

                const dateLabel = document.createElement('span');
                dateLabel.className = 'calendar-cell__date';
                dateLabel.textContent = `${weekdayFormatter.format(cellDate)} ${cellDate.getDate()}`;
                cell.appendChild(dateLabel);

                const dayEvents = eventsByDate.get(isoDate) || [];

                if (dayEvents.length) {
                    const countBadge = document.createElement('span');
                    countBadge.className = 'calendar-cell__count';
                    countBadge.textContent = `${dayEvents.length} event${dayEvents.length === 1 ? '' : 's'}`;
                    cell.appendChild(countBadge);

                    const list = document.createElement('ul');
                    list.className = 'calendar-cell__events';

                    dayEvents.slice(0, 3).forEach((event) => {
                        const item = document.createElement('li');
                        item.className = `calendar-cell__event calendar-cell__event--${event.staffingLevel || 'neutral'}`;
                        item.textContent = event.name;
                        item.title = `${event.name} · ${event.staffingStatus || 'Staffing pending'}`;
                        list.appendChild(item);
                    });

                    cell.appendChild(list);

                    if (dayEvents.length > 3) {
                        const more = document.createElement('span');
                        more.className = 'calendar-cell__more';
                        more.textContent = `+${dayEvents.length - 3} more`;
                        cell.appendChild(more);
                    }
                }

                cell.addEventListener('click', () => {
                    if (cellDate.getMonth() !== state.currentMonth.getMonth()) {
                        state.currentMonth = new Date(cellDate.getFullYear(), cellDate.getMonth(), 1);
                    }
                    state.selectedDate = new Date(cellDate.getFullYear(), cellDate.getMonth(), cellDate.getDate());
                    renderCalendar();
                    renderDayDetails();
                });

                cell.addEventListener('keydown', (event) => {
                    if (event.key === 'Enter' || event.key === ' ') {
                        event.preventDefault();
                        cell.click();
                    }
                });

                calendarGrid.appendChild(cell);
            }
        }

        function renderDayDetails() {
            if (!calendarDayList || !calendarSelectedHeading || !calendarSelectedSummary) {
                return;
            }

            calendarDayList.innerHTML = '';

            const eventsByDate = getEventsByDate();
            const iso = toISODate(state.selectedDate);
            const dayEvents = eventsByDate.get(iso) || [];
            const headingText = dayFormatter.format(state.selectedDate);

            calendarSelectedHeading.textContent = headingText;

            if (dayEvents.length === 0) {
                calendarSelectedSummary.textContent = 'No events on the books for this day.';
                const empty = document.createElement('p');
                empty.className = 'empty-state';
                empty.textContent = 'Add an event from the Events page to see it here.';
                calendarDayList.appendChild(empty);
                return;
            }

            const earliest = dayEvents.reduce((lowest, event) => {
                const timestamp = getEventTimestamp(event);
                return Math.min(lowest, timestamp);
            }, Number.MAX_SAFE_INTEGER);

            if (earliest && earliest !== Number.MAX_SAFE_INTEGER) {
                const earliestDate = new Date(earliest);
                calendarSelectedSummary.textContent = `${dayEvents.length} event${dayEvents.length === 1 ? '' : 's'} scheduled. First call time ${timeFormatter.format(earliestDate)}.`;
            } else {
                calendarSelectedSummary.textContent = `${dayEvents.length} event${dayEvents.length === 1 ? '' : 's'} scheduled.`;
            }

            dayEvents.forEach((event) => {
                const item = document.createElement('article');
                item.className = 'calendar-detail__item';

                const title = document.createElement('h4');
                title.className = 'calendar-detail__item-title';
                title.textContent = event.name;

                const meta = document.createElement('p');
                meta.className = 'calendar-detail__item-meta';
                const location = event.location ? ` · ${event.location}` : '';
                meta.textContent = `${formatEventTime(event)}${location}`;

                const staffing = document.createElement('p');
                staffing.className = 'calendar-detail__item-staff';
                const staffNames = getStaffNames(event.assignedStaffIds);
                if (staffNames.length) {
                    staffing.textContent = `Assigned: ${staffNames.join(', ')}`;
                } else {
                    staffing.textContent = event.staffingStatus || 'Staffing pending';
                }

                const note = document.createElement('p');
                note.className = 'calendar-detail__item-note';
                note.textContent = event.notes ? event.notes : 'No notes yet.';

                const linkRow = document.createElement('div');
                linkRow.className = 'calendar-detail__item-actions';
                const eventsLink = document.createElement('a');
                eventsLink.href = `events.html#event-pipeline`;
                eventsLink.className = 'calendar-detail__link';
                eventsLink.textContent = 'Manage in Events';
                linkRow.appendChild(eventsLink);

                item.appendChild(title);
                item.appendChild(meta);
                item.appendChild(staffing);
                item.appendChild(note);
                item.appendChild(linkRow);
                calendarDayList.appendChild(item);
            });
        }

        function estimatePrepHours(event) {
            if (!event) {
                return 0;
            }

            const guests = event.guestCount || 0;
            const base = guests ? Math.max(2, Math.ceil(guests / 40)) : 3;
            return event.staffingLevel === 'success' ? base : base + 1;
        }

        function renderWeekSummary(events) {
            if (!weekSummaryTable) {
                return;
            }

            weekSummaryTable.innerHTML = '';

            if (!store) {
                const row = document.createElement('tr');
                const cell = document.createElement('td');
                cell.colSpan = 5;
                cell.className = 'empty-state';
                cell.textContent = 'Unable to load weekly summary.';
                row.appendChild(cell);
                weekSummaryTable.appendChild(row);
                return;
            }

            const now = Date.now();
            const oneWeek = 1000 * 60 * 60 * 24 * 7;
            const upcomingWeek = events
                .slice()
                .sort((a, b) => getEventTimestamp(a) - getEventTimestamp(b))
                .filter((event) => {
                    const timestamp = getEventTimestamp(event);
                    return timestamp >= now && timestamp <= now + oneWeek;
                })
                .slice(0, 6);

            if (upcomingWeek.length === 0) {
                const row = document.createElement('tr');
                const cell = document.createElement('td');
                cell.colSpan = 5;
                cell.className = 'empty-state';
                cell.textContent = 'Nothing booked for the next seven days.';
                row.appendChild(cell);
                weekSummaryTable.appendChild(row);
                return;
            }

            upcomingWeek.forEach((event) => {
                const row = document.createElement('tr');

                const nameCell = document.createElement('td');
                nameCell.textContent = event.name;
                nameCell.setAttribute('data-label', 'Event');

                const dateCell = document.createElement('td');
                dateCell.textContent = formatEventDate(event.date);
                dateCell.setAttribute('data-label', 'Date');

                const guestCell = document.createElement('td');
                guestCell.textContent = event.guestCount ? event.guestCount : '—';
                guestCell.setAttribute('data-label', 'Guests');

                const teamCell = document.createElement('td');
                const staffNames = getStaffNames(event.assignedStaffIds);
                teamCell.textContent = staffNames.length ? `Assigned: ${staffNames.join(', ')}` : event.staffingStatus || 'Staffing pending';
                teamCell.textContent = event.staffingStatus || 'Staffing pending';
                teamCell.setAttribute('data-label', 'Team');

                const prepCell = document.createElement('td');
                prepCell.textContent = estimatePrepHours(event);
                prepCell.setAttribute('data-label', 'Prep hours');

                row.appendChild(nameCell);
                row.appendChild(dateCell);
                row.appendChild(guestCell);
                row.appendChild(teamCell);
                row.appendChild(prepCell);
                weekSummaryTable.appendChild(row);
            });
        }

        function refreshCalendar() {
            if (!store) {
                state.events = [];
                state.employees = [];
                state.employeeMap.clear();
                renderCalendar();
                renderDayDetails();
                renderWeekSummary([]);
                return;
            }

            state.events = store.getEvents();
            state.employees = store.getEmployees();
            buildEmployeeIndex();

            if (!(state.selectedDate instanceof Date) || Number.isNaN(state.selectedDate.getTime())) {
                state.selectedDate = new Date(today.getFullYear(), today.getMonth(), today.getDate());
            }

            renderCalendar();
            renderDayDetails();
            renderWeekSummary(state.events);
        }

        if (navButtons.length) {
            navButtons.forEach((button) => {
                button.addEventListener('click', () => {
                    const action = button.dataset.calendarNav;
                    if (!action) {
                        return;
                    }

                    if (action === 'prev') {
                        state.currentMonth = new Date(state.currentMonth.getFullYear(), state.currentMonth.getMonth() - 1, 1);
                        state.selectedDate = new Date(state.currentMonth.getFullYear(), state.currentMonth.getMonth(), 1);
                    } else if (action === 'next') {
                        state.currentMonth = new Date(state.currentMonth.getFullYear(), state.currentMonth.getMonth() + 1, 1);
                        state.selectedDate = new Date(state.currentMonth.getFullYear(), state.currentMonth.getMonth(), 1);
                    } else if (action === 'today') {
                        state.currentMonth = new Date(today.getFullYear(), today.getMonth(), 1);
                        state.selectedDate = new Date(today.getFullYear(), today.getMonth(), today.getDate());
                    }

                    renderCalendar();
                    renderDayDetails();
                });
            });
        }

        refreshCalendar();
    </script>
    <script src="app.js"></script>
</body>
</html>
