<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Events - Bartending2U</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="styles.css" />
</head>
<body>
    <header class="top-bar">
        <div class="top-bar__inner">
            <div class="brand">
                <img src="IMG_9047.png" alt="Bartending2U logo" />
                <div class="brand__text">
                    <span class="brand__subtitle">Bartending2U</span>
                    <span class="brand__title">Scheduling Suite</span>
                </div>
            </div>

            <button
                class="mobile-nav-toggle"
                id="mobileNavToggle"
                type="button"
                aria-label="Toggle navigation"
                aria-expanded="false"
                data-mobile-nav-toggle
            >
                <span class="mobile-nav-toggle__icon" aria-hidden="true">☰</span>
                <span class="sr-only">Toggle navigation</span>
            </button>

            <nav class="nav-links" id="primaryNav">
                <a class="nav-link" href="index.html">Dashboard</a>
                <a class="nav-link active" href="events.html">Events</a>
                <a class="nav-link" href="leads.html">Leads</a>
                <a class="nav-link" href="employees.html">Employees</a>
                <a class="nav-link" href="calendar.html">Calendar</a>
                <a class="nav-link" href="settings.html">Settings</a>
            </nav>

            <a class="cta-button" href="#new-event">+ New Event</a>
        </div>
    </header>

    <main class="page-content">
        <section class="page-header">
            <div>
                <p class="page-eyebrow">Events</p>
                <h1 class="page-title">Manage events</h1>
                <p class="lead-text">Track confirmed gigs, proposals, and staffing status in one place.</p>
            </div>
            <div class="hero-actions">
                <a class="button primary" href="#new-event" data-subsection-target="new-event">Log new booking</a>
                <a class="secondary-link" href="calendar.html">Sync with calendar →</a>
            </div>
        </section>

        <section id="event-pipeline" class="content-card" data-subsection="Event pipeline">
            <div class="card-header">
                <div>
                    <h2 class="card-title">Event pipeline</h2>
                    <p class="card-subtitle">Filter bookings, review details, and update staffing.</p>
                </div>
            </div>
            <div class="tab-bar">
                <button class="tab active" type="button" data-filter="all">All</button>
                <button class="tab" type="button" data-filter="confirmed">Confirmed</button>
                <button class="tab" type="button" data-filter="pending">Pending</button>
                <button class="tab" type="button" data-filter="drafts">Drafts</button>
            </div>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>Event</th>
                            <th>Date</th>
                            <th>Location</th>
                            <th>Package</th>
                            <th>Status</th>
                            <th>Staffing</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="eventsTableBody"></tbody>
                </table>
            </div>
        </section>

        <section id="new-event" class="content-card" data-subsection="Create new event">
            <div class="card-header">
                <div>
                    <h2 class="card-title">Create new event</h2>
                    <p class="card-subtitle">Log the basics, set staffing needs, and keep notes handy.</p>
                </div>
            </div>
            <form id="eventForm">
                <div class="form-grid">
                    <div class="form-field">
                        <label for="eventName">Event name</label>
                        <input id="eventName" name="name" type="text" placeholder="E.g. Winter Soirée" required />
                    </div>
                    <div class="form-field">
                        <label for="eventDate">Date</label>
                        <input id="eventDate" name="date" type="date" required />
                    </div>
                    <div class="form-field">
                        <label for="eventTime">Start time</label>
                        <input id="eventTime" name="time" type="time" />
                    </div>
                    <div class="form-field">
                        <label for="eventLocation">Location</label>
                        <input id="eventLocation" name="location" type="text" placeholder="Venue or address" />
                    </div>
                    <div class="form-field">
                        <label for="eventPackage">Service package</label>
                        <select id="eventPackage" name="package" required>
                            <option value="" selected disabled>Select package</option>
                            <option>Signature Cocktail Bar</option>
                            <option>Premium Mixology</option>
                            <option>Interactive Workshop</option>
                            <option>Custom Experience</option>
                        </select>
                    </div>
                    <div class="form-field">
                        <label for="guestCount">Guest count</label>
                        <input id="guestCount" name="guestCount" type="number" min="0" placeholder="Expected attendees" />
                    </div>
                    <div class="form-field">
                        <label for="eventPayout">Estimated payout (USD)</label>
                        <input id="eventPayout" name="payout" type="number" min="0" step="50" placeholder="0" />
                    </div>
                    <div class="form-field">
                        <label for="requiredStaff">Target staff count</label>
                        <input id="requiredStaff" name="requiredStaff" type="number" min="0" step="1" placeholder="0" />
                    </div>
                </div>
                <div class="form-grid">
                    <div class="form-field">
                        <label for="eventStatus">Event status</label>
                        <select id="eventStatus" name="status" required>
                            <option value="" disabled>Select status</option>
                            <option value="Confirmed" data-level="success" selected>Confirmed</option>
                            <option value="Awaiting deposit" data-level="warning">Awaiting deposit</option>
                            <option value="Contract overdue" data-level="danger">Contract overdue</option>
                            <option value="Proposal sent" data-level="info">Proposal sent</option>
                            <option value="Draft" data-level="neutral">Draft</option>
                        </select>
                    </div>
                    <div class="form-field">
                        <label for="eventStaffing">Staffing status</label>
                        <select id="eventStaffing" name="staffingStatus" required>
                            <option value="" disabled>Select staffing</option>
                            <option value="Fully staffed" data-level="success" selected>Fully staffed</option>
                            <option value="Ready" data-level="success">Ready</option>
                            <option value="Needs 1 bartender" data-level="warning">Needs 1 bartender</option>
                            <option value="Needs 2 bartenders" data-level="warning">Needs 2 bartenders</option>
                            <option value="Unassigned" data-level="danger">Unassigned</option>
                        </select>
                    </div>
                </div>
                <div class="form-field">
                    <label for="eventNotes">Notes & client preferences</label>
                    <textarea id="eventNotes" name="notes" placeholder="Share tastings, specialty cocktails, or logistics."></textarea>
                </div>
                <div class="table-actions" style="justify-content: flex-end;">
                    <button class="button ghost" type="reset">Clear</button>
                    <button class="button primary" type="submit">Save event</button>
                </div>
            </form>
        </section>
    </main>

    <div class="modal-backdrop" id="modalBackdrop" hidden>
        <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
            <div class="modal__header">
                <h2 class="modal__title" id="modalTitle">Event</h2>
                <button class="modal__close" type="button" data-modal-close aria-label="Close dialog">✕</button>
            </div>
            <div class="modal__body" id="modalBody"></div>
            <div class="modal__footer" id="modalFooter"></div>
        </div>
    </div>

    <div class="toast" id="toast" role="status" aria-live="polite"></div>

    <footer class="app-footer">© 2025 Bartending2U. Crafted for seamless event coordination.</footer>

    <script src="scripts.js"></script>
    <script src="storage.js"></script>

    <script>
        const navToggle = document.getElementById('mobileNavToggle');
        const nav = document.getElementById('primaryNav');

        if (navToggle && nav) {
            navToggle.addEventListener('click', () => {
                nav.classList.toggle('open');
            });
        }

        const store = window.B2UStore;
        const tableBody = document.getElementById('eventsTableBody');
        const form = document.getElementById('eventForm');
        const tabs = document.querySelectorAll('.tab');
        const modalBackdrop = document.getElementById('modalBackdrop');
        const modalTitle = document.getElementById('modalTitle');
        const modalBody = document.getElementById('modalBody');
        const modalFooter = document.getElementById('modalFooter');
        const toast = document.getElementById('toast');

        const currencyFormatter = new Intl.NumberFormat('en-US', {
            style: 'currency',
            currency: 'USD',
            maximumFractionDigits: 0,
        });
        const dateFormatter = new Intl.DateTimeFormat('en-US', {
            month: 'short',
            day: 'numeric',
            year: 'numeric',
        });
        const dateTimeFormatter = new Intl.DateTimeFormat('en-US', {
            month: 'short',
            day: 'numeric',
            year: 'numeric',
            hour: 'numeric',
            minute: '2-digit',
        });
        const relativeFormatter = new Intl.RelativeTimeFormat('en', { numeric: 'auto' });

        const state = {
            filter: 'all',
            events: [],
            employees: [],
            employeeMap: new Map(),
        };

        let toastTimeoutId = null;

        function showToast(message, variant = 'info') {
            if (!toast) {
                return;
            }

            toast.textContent = message;
            toast.dataset.variant = variant;
            toast.classList.remove('toast--visible');
            void toast.offsetWidth;
            toast.classList.add('toast--visible');

            if (toastTimeoutId) {
                clearTimeout(toastTimeoutId);
            }

            toastTimeoutId = setTimeout(() => {
                toast.classList.remove('toast--visible');
            }, 3200);
        }

        function closeModal() {
            if (!modalBackdrop) {
                return;
            }

            modalBackdrop.classList.remove('is-visible');
            modalBackdrop.hidden = true;
            if (modalBody) {
                modalBody.innerHTML = '';
            }
            if (modalFooter) {
                modalFooter.innerHTML = '';
            }
            document.body.classList.remove('modal-open');
        }

        function openModal(options) {
            if (!modalBackdrop || !modalTitle || !modalBody || !modalFooter) {
                return;
            }

            closeModal();

            const { title, body, actions = [] } = options || {};

            modalTitle.textContent = title || 'Details';

            if (body instanceof Element) {
                modalBody.innerHTML = '';
                modalBody.appendChild(body);
            } else if (typeof body === 'string') {
                modalBody.innerHTML = body;
            } else {
                modalBody.innerHTML = '<p class="empty-state">Nothing to show.</p>';
            }

            modalFooter.innerHTML = '';
            actions.forEach((action) => {
                const button = document.createElement('button');
                button.type = action.type || 'button';
                button.className = `button ${action.variant || 'ghost'}`;
                button.textContent = action.label || 'Action';

                if (typeof action.onClick === 'function') {
                    button.addEventListener('click', action.onClick);
                }

                modalFooter.appendChild(button);
            });

            modalBackdrop.hidden = false;
            requestAnimationFrame(() => {
                modalBackdrop.classList.add('is-visible');
            });
            document.body.classList.add('modal-open');
        }

        if (modalBackdrop) {
            modalBackdrop.addEventListener('click', (event) => {
                if (event.target === modalBackdrop) {
                    closeModal();
                }
            });
        }

        document.querySelectorAll('[data-modal-close]').forEach((button) => {
            button.addEventListener('click', () => {
                closeModal();
            });
        });

        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape' && modalBackdrop && !modalBackdrop.hidden) {
                closeModal();
            }
        });

        function formatDate(dateStr, timeStr) {
            if (!dateStr) {
                return 'Date TBC';
            }

            const date = new Date(`${dateStr}T${timeStr || '12:00'}`);
            if (Number.isNaN(date.getTime())) {
                return 'Date TBC';
            }

            return timeStr ? dateTimeFormatter.format(date) : dateFormatter.format(date);
        }

        function formatCurrency(amount) {
            if (typeof amount !== 'number' || Number.isNaN(amount)) {
                return '$0';
            }
            return currencyFormatter.format(amount);
        }

        function getEventTimestamp(event) {
            if (!event || !event.date) {
                return Number.MAX_SAFE_INTEGER;
            }

            const timestamp = new Date(`${event.date}T${event.time || '00:00'}`).getTime();
            return Number.isNaN(timestamp) ? Number.MAX_SAFE_INTEGER : timestamp;
        }

        function refreshData() {
            if (!store) {
                state.events = [];
                state.employees = [];
                state.employeeMap.clear();
                return;
            }

            state.events = store.getEvents();
            state.employees = store.getEmployees();
            state.employeeMap.clear();
            state.employees.forEach((employee) => {
                state.employeeMap.set(employee.id, employee);
            });
        }

        function getStaffNames(ids) {
            if (!Array.isArray(ids) || ids.length === 0) {
                return [];
            }

            return ids
                .map((id) => state.employeeMap.get(id))
                .filter(Boolean)
                .map((employee) => employee.name);
        }

        function filterEvents(events) {
            switch (state.filter) {
                case 'confirmed':
                    return events.filter((event) => event.statusLevel === 'success');
                case 'pending':
                    return events.filter((event) => event.statusLevel !== 'success');
                case 'drafts':
                    return events.filter((event) => (event.status || '').toLowerCase().includes('draft'));
                default:
                    return events;
            }
        }

        function createBadge(text, level) {
            const badge = document.createElement('span');
            badge.className = `badge ${level || 'neutral'}`;
            badge.textContent = text;
            return badge;
        }

        function getStaffingSummary(event) {
            const names = getStaffNames(event.assignedStaffIds || []);
            const required = typeof event.requiredStaff === 'number' && event.requiredStaff > 0 ? event.requiredStaff : 0;
            const summary = {
                text: event.staffingStatus || 'Unassigned',
                title: event.staffingStatus || 'Unassigned',
            };

            if (names.length) {
                if (required) {
                    summary.text = `${names.length}/${required} assigned`;
                } else {
                    summary.text = `${names.length} assigned`;
                }
                summary.title = names.join(', ');
            }

            return summary;
        }

        function getActionsForEvent(event) {
            const actions = [
                { id: 'view', label: 'View' },
                { id: 'staff', label: 'Staff' },
                { id: 'notes', label: 'Notes' },
            ];

            if (event.statusLevel === 'success') {
                actions.push({ id: 'checklist', label: 'Checklist' });
            } else {
                actions.push({ id: 'reminder', label: 'Send reminder' });
            }

            actions.push({ id: 'remove', label: 'Remove', variant: 'danger' });
            return actions;
        }

        function formatRelativeTime(timestamp) {
            if (!timestamp) {
                return 'Never';
            }

            const diff = timestamp - Date.now();
            const minutes = Math.round(diff / (1000 * 60));
            if (Math.abs(minutes) < 60) {
                return relativeFormatter.format(minutes, 'minute');
            }

            const hours = Math.round(diff / (1000 * 60 * 60));
            if (Math.abs(hours) < 24) {
                return relativeFormatter.format(hours, 'hour');
            }

            const days = Math.round(diff / (1000 * 60 * 60 * 24));
            return relativeFormatter.format(days, 'day');
        }

        function renderEvents() {
            if (!tableBody) {
                return;
            }

            tableBody.innerHTML = '';

            if (!store) {
                const row = document.createElement('tr');
                const cell = document.createElement('td');
                cell.colSpan = 7;
                cell.className = 'empty-state';
                cell.textContent = 'Storage service unavailable. Refresh to retry.';
                row.appendChild(cell);
                tableBody.appendChild(row);
                return;
            }

            const events = filterEvents(
                state.events
                    .slice()
                    .sort((a, b) => getEventTimestamp(a) - getEventTimestamp(b))
            );

            if (events.length === 0) {
                const row = document.createElement('tr');
                const cell = document.createElement('td');
                cell.colSpan = 7;
                cell.className = 'empty-state';
                cell.textContent = 'No events match this filter yet. Save one below to get started.';
                row.appendChild(cell);
                tableBody.appendChild(row);
                return;
            }

            events.forEach((event) => {
                const row = document.createElement('tr');
                row.dataset.eventId = event.id;

                const nameCell = document.createElement('td');
                nameCell.textContent = event.name;
                row.appendChild(nameCell);

                const dateCell = document.createElement('td');
                dateCell.textContent = formatDate(event.date, event.time);
                row.appendChild(dateCell);

                const locationCell = document.createElement('td');
                locationCell.textContent = event.location || 'Location TBC';
                row.appendChild(locationCell);

                const packageCell = document.createElement('td');
                const packageParts = [];
                if (event.package) {
                    packageParts.push(event.package);
                }
                if (event.guestCount) {
                    packageParts.push(`${event.guestCount} guests`);
                }
                if (typeof event.payout === 'number' && event.payout > 0) {
                    packageParts.push(formatCurrency(event.payout));
                }
                packageCell.textContent = packageParts.join(' · ') || 'Package TBC';
                row.appendChild(packageCell);

                const statusCell = document.createElement('td');
                statusCell.appendChild(createBadge(event.status || 'Pending', event.statusLevel));
                row.appendChild(statusCell);

                const staffingCell = document.createElement('td');
                const staffingSummary = getStaffingSummary(event);
                const staffingBadge = createBadge(staffingSummary.text, event.staffingLevel);
                staffingBadge.title = staffingSummary.title;
                staffingCell.appendChild(staffingBadge);
                row.appendChild(staffingCell);

                const actionsCell = document.createElement('td');
                actionsCell.className = 'table-actions';

                getActionsForEvent(event).forEach((action) => {
                    const button = document.createElement('button');
                    button.type = 'button';
                    button.className = 'card-action link-button';
                    if (action.variant === 'danger') {
                        button.classList.add('card-action--danger');
                    }
                    button.dataset.action = action.id;
                    button.dataset.eventId = event.id;
                    button.textContent = action.label;
                    actionsCell.appendChild(button);
                });

                row.appendChild(actionsCell);
                tableBody.appendChild(row);
            });
        }

        function handleViewEvent(eventData) {
            const wrapper = document.createElement('div');
            wrapper.className = 'modal-section';

            const list = document.createElement('dl');
            list.className = 'modal-summary';

            const addEntry = (label, value) => {
                const dt = document.createElement('dt');
                dt.textContent = label;
                const dd = document.createElement('dd');
                dd.textContent = value;
                list.appendChild(dt);
                list.appendChild(dd);
            };

            addEntry('Date', formatDate(eventData.date, eventData.time));
            addEntry('Location', eventData.location || 'Not set');
            addEntry('Package', eventData.package || 'Not set');
            addEntry('Guests', eventData.guestCount ? String(eventData.guestCount) : 'Not set');
            addEntry('Payout', eventData.payout ? formatCurrency(eventData.payout) : 'Not set');
            addEntry('Status', eventData.status || 'Pending');

            const staffingSummary = getStaffingSummary(eventData);
            addEntry('Staffing', staffingSummary.text);
            addEntry('Last reminder', eventData.lastReminderSent ? `${formatRelativeTime(eventData.lastReminderSent)} · ${dateTimeFormatter.format(new Date(eventData.lastReminderSent))}` : 'Never');

            wrapper.appendChild(list);

            const notesHeading = document.createElement('h4');
            notesHeading.textContent = 'Notes';
            notesHeading.className = 'modal-subheading';
            wrapper.appendChild(notesHeading);

            const notes = document.createElement('p');
            notes.className = 'modal-notes';
            notes.textContent = eventData.notes ? eventData.notes : 'No notes yet.';
            wrapper.appendChild(notes);

            openModal({
                title: eventData.name,
                body: wrapper,
                actions: [{ label: 'Close', variant: 'primary', onClick: closeModal }],
            });
        }

        function handleStaffEvent(eventData) {
            const formElement = document.createElement('form');
            formElement.className = 'modal-form';

            const helper = document.createElement('p');
            helper.className = 'form-helper';
            const required = typeof eventData.requiredStaff === 'number' && eventData.requiredStaff > 0 ? eventData.requiredStaff : 0;
            helper.textContent = required
                ? `Select up to ${required} team member${required === 1 ? '' : 's'}.`
                : 'Select the team members you want to assign.';
            formElement.appendChild(helper);

            const list = document.createElement('div');
            list.className = 'staff-picker';
            formElement.appendChild(list);

            const assignedSet = new Set(eventData.assignedStaffIds || []);

            if (state.employees.length === 0) {
                const empty = document.createElement('p');
                empty.className = 'empty-state';
                empty.textContent = 'Add team members first to assign staffing.';
                formElement.appendChild(empty);
            }

            state.employees.forEach((employee) => {
                const label = document.createElement('label');
                label.className = 'staff-picker__item';

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.name = 'staffMembers';
                checkbox.value = employee.id;
                checkbox.checked = assignedSet.has(employee.id);

                const name = document.createElement('span');
                name.className = 'staff-picker__name';
                name.textContent = employee.name;

                const role = document.createElement('span');
                role.className = 'staff-picker__meta';
                role.textContent = employee.role || '';

                const status = document.createElement('span');
                status.className = `badge ${employee.statusLevel || 'neutral'}`;
                status.textContent = employee.status || 'Status TBC';

                label.appendChild(checkbox);
                label.appendChild(name);
                label.appendChild(role);
                label.appendChild(status);

                list.appendChild(label);
            });

            formElement.addEventListener('submit', (event) => {
                event.preventDefault();
                if (!store) {
                    return;
                }

                const selected = Array.from(formElement.querySelectorAll('input[name="staffMembers"]:checked')).map((input) => input.value);
                store.assignStaff(eventData.id, selected);
                closeModal();
                showToast('Staff assignments saved', 'success');
                refreshData();
                renderEvents();
            });

            openModal({
                title: `Assign staff · ${eventData.name}`,
                body: formElement,
                actions: [
                    { label: 'Cancel', variant: 'ghost', onClick: closeModal },
                    { label: 'Save assignments', variant: 'primary', onClick: () => formElement.requestSubmit() },
                ],
            });

            const firstCheckbox = formElement.querySelector('input[type="checkbox"]');
            if (firstCheckbox) {
                firstCheckbox.focus();
            }
        }

        function handleNotesEvent(eventData) {
            const formElement = document.createElement('form');
            formElement.className = 'modal-form';

            const label = document.createElement('label');
            label.className = 'form-field';
            const span = document.createElement('span');
            span.textContent = 'Notes';
            const textarea = document.createElement('textarea');
            textarea.name = 'notes';
            textarea.rows = 6;
            textarea.value = eventData.notes || '';
            label.appendChild(span);
            label.appendChild(textarea);

            formElement.appendChild(label);

            const helper = document.createElement('p');
            helper.className = 'form-helper';
            helper.textContent = 'Saved notes appear in the calendar day view.';
            formElement.appendChild(helper);

            formElement.addEventListener('submit', (event) => {
                event.preventDefault();
                if (!store) {
                    return;
                }

                const nextNotes = textarea.value.trim();
                store.updateEvent(eventData.id, { notes: nextNotes });
                closeModal();
                showToast('Notes saved', 'success');
                refreshData();
                renderEvents();
            });

            openModal({
                title: `Notes · ${eventData.name}`,
                body: formElement,
                actions: [
                    { label: 'Cancel', variant: 'ghost', onClick: closeModal },
                    { label: 'Save notes', variant: 'primary', onClick: () => formElement.requestSubmit() },
                ],
            });

            textarea.focus();
        }

        function handleReminderEvent(eventData) {
            const formElement = document.createElement('form');
            formElement.className = 'modal-form';

            const info = document.createElement('p');
            info.className = 'form-helper';
            info.textContent = eventData.lastReminderSent
                ? `Last reminder ${formatRelativeTime(eventData.lastReminderSent)} (${dateTimeFormatter.format(new Date(eventData.lastReminderSent))}).`
                : 'No reminders have been logged for this event yet.';
            formElement.appendChild(info);

            const label = document.createElement('label');
            label.className = 'form-field';
            const span = document.createElement('span');
            span.textContent = 'Message';
            const textarea = document.createElement('textarea');
            textarea.name = 'reminderMessage';
            textarea.rows = 5;
            const friendlyDate = formatDate(eventData.date, eventData.time);
            textarea.value = `Hi there! Checking in on ${eventData.name} scheduled for ${friendlyDate}. Let me know if you have any updates.`;
            label.appendChild(span);
            label.appendChild(textarea);
            formElement.appendChild(label);

            formElement.addEventListener('submit', (event) => {
                event.preventDefault();
                if (!store) {
                    return;
                }

                const message = textarea.value.trim();
                const timestamp = Date.now();
                const existingNotes = eventData.notes ? `${eventData.notes}\n\n` : '';
                const nextNotes = message
                    ? `${existingNotes}Reminder logged ${dateTimeFormatter.format(new Date(timestamp))}: ${message}`
                    : eventData.notes || '';

                store.updateEvent(eventData.id, {
                    lastReminderSent: timestamp,
                    notes: nextNotes,
                });
                closeModal();
                showToast('Reminder logged', 'success');
                refreshData();
                renderEvents();
            });

            openModal({
                title: `Send reminder · ${eventData.name}`,
                body: formElement,
                actions: [
                    { label: 'Cancel', variant: 'ghost', onClick: closeModal },
                    { label: 'Log reminder', variant: 'primary', onClick: () => formElement.requestSubmit() },
                ],
            });

            textarea.focus();
        }

        function handleChecklistEvent(eventData) {
            const wrapper = document.createElement('div');
            wrapper.className = 'modal-section';

            const intro = document.createElement('p');
            intro.className = 'form-helper';
            intro.textContent = 'Mark tasks as you prep. Progress is saved while this window stays open.';
            wrapper.appendChild(intro);

            const assignedNames = getStaffNames(eventData.assignedStaffIds || []);
            const staffLabel = assignedNames.length ? assignedNames.join(', ') : 'assigned staff';
            const tasks = [
                `Confirm call times with ${staffLabel}.`,
                `Review the menu for ${eventData.package || 'the selected package'}.`,
                'Finalize the shopping list and rentals.',
                'Send arrival instructions to the client.',
            ];

            const list = document.createElement('ul');
            list.className = 'checklist';
            wrapper.appendChild(list);

            tasks.forEach((task, index) => {
                const item = document.createElement('li');
                const label = document.createElement('label');
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.dataset.index = String(index);
                const text = document.createElement('span');
                text.textContent = task;
                label.appendChild(checkbox);
                label.appendChild(text);
                item.appendChild(label);
                list.appendChild(item);
            });

            const progress = document.createElement('p');
            progress.className = 'form-helper';
            wrapper.appendChild(progress);

            const updateProgress = () => {
                const total = tasks.length;
                const done = list.querySelectorAll('input[type="checkbox"]:checked').length;
                progress.textContent = `${done}/${total} tasks complete`;
            };

            list.addEventListener('change', updateProgress);
            updateProgress();

            openModal({
                title: `Checklist · ${eventData.name}`,
                body: wrapper,
                actions: [{ label: 'Close', variant: 'primary', onClick: closeModal }],
            });

            const firstCheckbox = list.querySelector('input[type="checkbox"]');
            if (firstCheckbox) {
                firstCheckbox.focus();
            }
        }

        if (tabs.length) {
            tabs.forEach((tab) => {
                tab.addEventListener('click', () => {
                    tabs.forEach((button) => button.classList.remove('active'));
                    tab.classList.add('active');
                    state.filter = tab.dataset.filter || 'all';
                    renderEvents();
                });
            });
        }

        if (tableBody) {
            tableBody.addEventListener('click', (event) => {
                const actionButton = event.target.closest('[data-action]');
                if (!actionButton) {
                    return;
                }

                const action = actionButton.dataset.action;
                const eventId = actionButton.dataset.eventId;
                if (!action || !eventId) {
                    return;
                }

                const eventData = state.events.find((item) => item.id === eventId);
                if (!eventData) {
                    return;
                }

                if (!store) {
                    showToast('Storage unavailable right now.', 'error');
                    return;
                }

                switch (action) {
                    case 'view':
                        handleViewEvent(eventData);
                        break;
                    case 'staff':
                        handleStaffEvent(eventData);
                        break;
                    case 'notes':
                        handleNotesEvent(eventData);
                        break;
                    case 'reminder':
                        handleReminderEvent(eventData);
                        break;
                    case 'checklist':
                        handleChecklistEvent(eventData);
                        break;
                    case 'remove':
                        store.removeEvent(eventId);
                        showToast('Event removed', 'success');
                        refreshData();
                        renderEvents();
                        break;
                    default:
                        break;
                }
            });
        }

        if (form && store) {
            form.addEventListener('submit', (event) => {
                event.preventDefault();

                const formData = new FormData(form);
                const statusOption = form.eventStatus.options[form.eventStatus.selectedIndex];
                const staffingOption = form.eventStaffing.options[form.eventStaffing.selectedIndex];

                const eventPayload = {
                    name: (formData.get('name') || '').trim() || 'Untitled event',
                    date: formData.get('date') || '',
                    time: formData.get('time') || '',
                    location: (formData.get('location') || '').trim(),
                    package: formData.get('package') || '',
                    guestCount: Number(formData.get('guestCount') || 0),
                    payout: Number(formData.get('payout') || 0),
                    requiredStaff: Number(formData.get('requiredStaff') || 0),
                    status: formData.get('status') || 'Draft',
                    statusLevel: statusOption ? statusOption.dataset.level : undefined,
                    staffingStatus: formData.get('staffingStatus') || 'Unassigned',
                    staffingLevel: staffingOption ? staffingOption.dataset.level : undefined,
                    notes: (formData.get('notes') || '').trim(),
                };

                store.addEvent(eventPayload);
                showToast('Event saved', 'success');

                form.reset();
                if (form.eventStatus) {
                    form.eventStatus.value = 'Confirmed';
                }
                if (form.eventStaffing) {
                    form.eventStaffing.value = 'Fully staffed';
                }

                refreshData();
                renderEvents();
            });
        }

        refreshData();
        renderEvents();
    </script>

    <script src="app.js"></script>
</body>
</html>
