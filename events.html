<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Events - Bartending2U</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="styles.css" />
</head>
<body>
    <header class="top-bar">
        <div class="top-bar__inner">
            <div class="brand">
                <img src="IMG_9047.png" alt="Bartending2U logo" />
                <div class="brand__text">
                    <span class="brand__subtitle">Bartending2U</span>
                    <span class="brand__title">Scheduling Suite</span>
                </div>
            </div>

            <button
                class="mobile-nav-toggle"
                id="mobileNavToggle"
                type="button"
                aria-label="Toggle navigation"
                aria-expanded="false"
                data-mobile-nav-toggle
            >
                <span class="mobile-nav-toggle__icon" aria-hidden="true">☰</span>
                <span class="sr-only">Toggle navigation</span>
            </button>

            <nav class="nav-links" id="primaryNav">
                <a class="nav-link" href="index.html">Dashboard</a>
                <a class="nav-link active" href="events.html">Events</a>
                <a class="nav-link" href="leads.html">Leads</a>
                <a class="nav-link" href="employees.html">Employees</a>
                <a class="nav-link" href="calendar.html">Calendar</a>
                <a class="nav-link" href="settings.html">Settings</a>
            </nav>

            <a class="cta-button" href="#new-event">+ New Event</a>
        </div>
    </header>

    <main class="page-content">
        <section class="page-header">
            <div>
                <p class="page-eyebrow">Events</p>
                <h1 class="page-title">Manage events</h1>
                <p class="lead-text">Track confirmed gigs, proposals, and staffing status in one place.</p>
            </div>
            <div class="hero-actions">
                <a class="button primary" href="#new-event" data-subsection-target="new-event">Log new booking</a>
                <a class="secondary-link" href="calendar.html">Sync with calendar →</a>
            </div>
        </section>

        <section id="event-pipeline" class="content-card" data-subsection="Event pipeline">
            <div class="card-header">
                <div>
                    <h2 class="card-title">Event pipeline</h2>
                    <p class="card-subtitle">Filter bookings, review details, and update staffing.</p>
                </div>
            </div>
            <div class="tab-bar">
                <button class="tab active" type="button" data-filter="all">All</button>
                <button class="tab" type="button" data-filter="confirmed">Confirmed</button>
                <button class="tab" type="button" data-filter="pending">Pending</button>
                <button class="tab" type="button" data-filter="drafts">Drafts</button>
            </div>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>Event</th>
                            <th>Date</th>
                            <th>Location</th>
                            <th>Package</th>
                            <th>Status</th>
                            <th>Staffing</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="eventsTableBody"></tbody>
                </table>
            </div>
        </section>

        <section id="new-event" class="content-card" data-subsection="Create new event">
            <div class="card-header">
                <div>
                    <h2 class="card-title">Create new event</h2>
                    <p class="card-subtitle">Capture the essentials, assign talent, and keep clients delighted.</p>
                    <p class="form-mode-indicator" id="eventFormModeIndicator" aria-live="polite"></p>
                    <p class="card-subtitle">Log the basics, set staffing needs, and keep notes handy.</p>
                </div>
            </div>
            <form id="eventForm">
                <input id="eventId" name="id" type="hidden" />
                <div class="form-grid">
                    <div class="form-field">
                        <label for="eventName">Event name</label>
                        <input id="eventName" name="name" type="text" placeholder="E.g. Winter Soirée" required />
                    </div>
                    <div class="form-field">
                        <label for="eventDate">Date</label>
                        <input id="eventDate" name="date" type="date" required />
                    </div>
                    <div class="form-field">
                        <label for="eventTime">Start time</label>
                        <input id="eventTime" name="time" type="time" />
                    </div>
                    <div class="form-field">
                        <label for="eventLocation">Location</label>
                        <input id="eventLocation" name="location" type="text" placeholder="Venue or address" />
                    </div>
                    <div class="form-field">
                        <label for="eventPackage">Service package</label>
                        <select id="eventPackage" name="package" required>
                            <option value="" selected disabled>Select package</option>
                            <option>Signature Cocktail Bar</option>
                            <option>Premium Mixology</option>
                            <option>Interactive Workshop</option>
                            <option>Custom Experience</option>
                        </select>
                    </div>
                    <div class="form-field">
                        <label for="guestCount">Guest count</label>
                        <input id="guestCount" name="guestCount" type="number" min="0" placeholder="Expected attendees" />
                    </div>
                    <div class="form-field">
                        <label for="eventPayout">Estimated payout (USD)</label>
                        <input id="eventPayout" name="payout" type="number" min="0" step="50" placeholder="0" />
                    </div>
                    <div class="form-field">
                        <label for="requiredStaff">Target staff count</label>
                        <input id="requiredStaff" name="requiredStaff" type="number" min="0" step="1" placeholder="0" />
                    </div>
                </div>
                <div class="form-grid">
                    <div class="form-field">
                        <label for="eventStatus">Event status</label>
                        <select id="eventStatus" name="status" required>
                            <option value="" disabled>Select status</option>
                            <option value="Confirmed" data-level="success" selected>Confirmed</option>
                            <option value="Awaiting deposit" data-level="warning">Awaiting deposit</option>
                            <option value="Contract overdue" data-level="danger">Contract overdue</option>
                            <option value="Proposal sent" data-level="info">Proposal sent</option>
                            <option value="Draft" data-level="neutral">Draft</option>
                        </select>
                    </div>
                    <div class="form-field">
                        <label for="eventStaffing">Staffing status</label>
                        <select id="eventStaffing" name="staffingStatus" required>
                            <option value="" disabled>Select staffing</option>
                            <option value="Fully staffed" data-level="success" selected>Fully staffed</option>
                            <option value="Ready" data-level="success">Ready</option>
                            <option value="Needs 1 bartender" data-level="warning">Needs 1 bartender</option>
                            <option value="Needs 2 bartenders" data-level="warning">Needs 2 bartenders</option>
                            <option value="Unassigned" data-level="danger">Unassigned</option>
                        </select>
                    </div>
                </div>
                <div class="form-field">
                    <label for="eventNotes">Notes & client preferences</label>
                    <textarea id="eventNotes" name="notes" placeholder="Share tastings, specialty cocktails, or logistics."></textarea>
                </div>
                <div class="table-actions" style="justify-content: flex-end;">
                    <button class="button ghost" type="reset">Clear</button>
                    <button class="button primary" type="submit">Save event</button>
                </div>
            </form>
        </section>

        <div id="eventModal" class="modal" hidden>
            <div class="modal__backdrop" data-modal-dismiss></div>
            <div class="modal__panel" role="dialog" aria-modal="true" aria-labelledby="eventModalTitle">
                <button class="modal__close" type="button" aria-label="Close" data-modal-dismiss>&times;</button>
                <div class="modal__header">
                    <h3 class="modal__title" id="eventModalTitle"></h3>
                    <p class="modal__subtitle" data-modal-subtitle></p>
                </div>
                <div class="modal__content" data-modal-content></div>
            </div>
        </div>

        <template id="checklistTemplate">
            <div class="event-checklist">
                <ul class="event-checklist__items" data-checklist-items></ul>
                <form class="event-checklist__form" data-checklist-form>
                    <label class="sr-only" for="checklistNewItem">Add checklist item</label>
                    <input id="checklistNewItem" name="label" type="text" placeholder="Add new item" required autocomplete="off" />
                    <button class="button primary" type="submit">Add</button>
                </form>
            </div>
        </template>

        <template id="prepSheetTemplate">
            <form class="prep-sheet" data-prep-form>
                <div class="prep-sheet__fields">
                    <label class="form-field">
                        <span class="form-field__label">Menu focus</span>
                        <textarea name="menu" rows="3" placeholder="Signature cocktails, mocktail options, etc."></textarea>
                    </label>
                    <label class="form-field">
                        <span class="form-field__label">Equipment & logistics</span>
                        <textarea name="equipment" rows="3" placeholder="Bar kits, glassware counts, load-in notes"></textarea>
                    </label>
                    <label class="form-field">
                        <span class="form-field__label">Staffing notes</span>
                        <textarea name="staffing" rows="3" placeholder="Arrival times, attire, assignments"></textarea>
                    </label>
                </div>
                <div class="prep-sheet__actions">
                    <span class="prep-sheet__status" aria-live="polite" data-prep-status></span>
                    <button class="button primary" type="submit">Save prep sheet</button>
                </div>
            </form>
        </template>
    </main>

    <div class="modal-backdrop" id="modalBackdrop" hidden>
        <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
            <div class="modal__header">
                <h2 class="modal__title" id="modalTitle">Event</h2>
                <button class="modal__close" type="button" data-modal-close aria-label="Close dialog">✕</button>
            </div>
            <div class="modal__body" id="modalBody"></div>
            <div class="modal__footer" id="modalFooter"></div>
        </div>
    </div>

    <div class="toast" id="toast" role="status" aria-live="polite"></div>

    <footer class="app-footer">© 2025 Bartending2U. Crafted for seamless event coordination.</footer>

    <script src="scripts.js"></script>
    <script src="storage.js"></script>

    <script>
        const navToggle = document.getElementById('mobileNavToggle');
        const nav = document.getElementById('primaryNav');

        if (navToggle && nav) {
            navToggle.addEventListener('click', () => {
                nav.classList.toggle('open');
            });
        }

        const store = window.B2UStore;
        const tableBody = document.getElementById('eventsTableBody');
        const form = document.getElementById('eventForm');
        const tabs = document.querySelectorAll('.tab');
        const submitButton = form ? form.querySelector('[type="submit"]') : null;
        const modeIndicator = document.getElementById('eventFormModeIndicator');
        const hiddenIdField = document.getElementById('eventId');
        let activeFilter = 'all';
        const modal = document.getElementById('eventModal');
        const modalTitleEl = modal ? modal.querySelector('#eventModalTitle') : null;
        const modalSubtitleEl = modal ? modal.querySelector('[data-modal-subtitle]') : null;
        const modalContentEl = modal ? modal.querySelector('[data-modal-content]') : null;
        const checklistTemplate = document.getElementById('checklistTemplate');
        const prepSheetTemplate = document.getElementById('prepSheetTemplate');
        let activeModal = null;
        let activeEvent = null;
        let editingEventId = null;

        const defaultStatusValue = 'Confirmed';
        const defaultStaffingValue = 'Fully staffed';
        const modalBackdrop = document.getElementById('modalBackdrop');
        const modalTitle = document.getElementById('modalTitle');
        const modalBody = document.getElementById('modalBody');
        const modalFooter = document.getElementById('modalFooter');
        const toast = document.getElementById('toast');

        const currencyFormatter = new Intl.NumberFormat('en-US', {
            style: 'currency',
            currency: 'USD',
            maximumFractionDigits: 0,
        });
        const dateFormatter = new Intl.DateTimeFormat('en-US', {
            month: 'short',
            day: 'numeric',
            year: 'numeric',
        });
        const dateTimeFormatter = new Intl.DateTimeFormat('en-US', {
            month: 'short',
            day: 'numeric',
            year: 'numeric',
            hour: 'numeric',
            minute: '2-digit',
        });
        const relativeFormatter = new Intl.RelativeTimeFormat('en', { numeric: 'auto' });

        const state = {
            filter: 'all',
            events: [],
            employees: [],
            employeeMap: new Map(),
        };

        let toastTimeoutId = null;

        function showToast(message, variant = 'info') {
            if (!toast) {
                return;
            }

            toast.textContent = message;
            toast.dataset.variant = variant;
            toast.classList.remove('toast--visible');
            void toast.offsetWidth;
            toast.classList.add('toast--visible');

            if (toastTimeoutId) {
                clearTimeout(toastTimeoutId);
            }

            toastTimeoutId = setTimeout(() => {
                toast.classList.remove('toast--visible');
            }, 3200);
        }

        function closeBackdropModal() {
            if (!modalBackdrop) {
                return;
            }

            modalBackdrop.classList.remove('is-visible');
            modalBackdrop.hidden = true;
            if (modalBody) {
                modalBody.innerHTML = '';
            }
            if (modalFooter) {
                modalFooter.innerHTML = '';
            }
            document.body.classList.remove('modal-open');
        }

        function openBackdropModal(options) {
            if (!modalBackdrop || !modalTitle || !modalBody || !modalFooter) {
                return;
            }

            closeBackdropModal();

            const { title, body, actions = [] } = options || {};

            modalTitle.textContent = title || 'Details';

            if (body instanceof Element) {
                modalBody.innerHTML = '';
                modalBody.appendChild(body);
            } else if (typeof body === 'string') {
                modalBody.innerHTML = body;
            } else {
                modalBody.innerHTML = '<p class="empty-state">Nothing to show.</p>';
            }

            modalFooter.innerHTML = '';
            actions.forEach((action) => {
                const button = document.createElement('button');
                button.type = action.type || 'button';
                button.className = `button ${action.variant || 'ghost'}`;
                button.textContent = action.label || 'Action';

                if (typeof action.onClick === 'function') {
                    button.addEventListener('click', action.onClick);
                }

                modalFooter.appendChild(button);
            });

            modalBackdrop.hidden = false;
            requestAnimationFrame(() => {
                modalBackdrop.classList.add('is-visible');
            });
            document.body.classList.add('modal-open');
        }

        if (modalBackdrop) {
            modalBackdrop.addEventListener('click', (event) => {
                if (event.target === modalBackdrop) {
                    closeBackdropModal();
                }
            });
        }

        document.querySelectorAll('[data-modal-close]').forEach((button) => {
            button.addEventListener('click', () => {
                closeBackdropModal();
            });
        });

        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape' && modalBackdrop && !modalBackdrop.hidden) {
                closeBackdropModal();
            }
        });

        function formatDate(dateStr, timeStr) {
            if (!dateStr) {
                return 'Date TBC';
            }

            const date = new Date(`${dateStr}T${timeStr || '12:00'}`);
            if (Number.isNaN(date.getTime())) {
                return 'Date TBC';
            }

            return timeStr ? dateTimeFormatter.format(date) : dateFormatter.format(date);
        }

        function formatCurrency(amount) {
            if (typeof amount !== 'number' || Number.isNaN(amount)) {
                return '$0';
            }
            return currencyFormatter.format(amount);
        }

        function formatModalSubtitle(event) {
            if (!event) {
                return '';
            }

            const parts = [];
            if (event.date) {
                parts.push(formatDate(event.date, event.time));
            }
            if (event.location) {
                parts.push(event.location);
            }
            return parts.join(' • ');
        }

        function refreshActiveEvent(eventId) {
            if (!store) {
                return null;
            }

            const idToFetch = eventId || (activeModal && activeModal.eventId);
            if (!idToFetch) {
                return null;
            }

            const next = store.getEvent(idToFetch);
            if (next) {
                activeEvent = next;
            }
            return next;
        }

        function createChecklistView(eventData) {
            const fragment = checklistTemplate && 'content' in checklistTemplate ? checklistTemplate.content.cloneNode(true) : null;
            const wrapper = fragment ? fragment.querySelector('.event-checklist') : document.createElement('div');

            if (!fragment) {
                wrapper.className = 'event-checklist';
                wrapper.innerHTML = '<ul class="event-checklist__items" data-checklist-items></ul>';
            }

            const list = wrapper.querySelector('[data-checklist-items]');
            const formEl = wrapper.querySelector('[data-checklist-form]');

            if (list) {
                list.innerHTML = '';
                const items = Array.isArray(eventData.checklist) ? eventData.checklist : [];

                if (!items.length) {
                    const empty = document.createElement('li');
                    empty.className = 'event-checklist__empty';
                    empty.textContent = 'No checklist items yet. Add one to get started.';
                    list.appendChild(empty);
                } else {
                    items.forEach((item) => {
                        const li = document.createElement('li');
                        li.className = 'event-checklist__item';
                        li.dataset.itemId = item.id;
                        if (item.completed) {
                            li.classList.add('is-complete');
                        }

                        const checkboxId = `${eventData.id}-${item.id}`;
                        const labelEl = document.createElement('label');
                        labelEl.className = 'checkbox-field';
                        labelEl.setAttribute('for', checkboxId);

                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.id = checkboxId;
                        checkbox.checked = Boolean(item.completed);
                        checkbox.dataset.checklistToggle = item.id;

                        const text = document.createElement('span');
                        text.textContent = item.label;

                        labelEl.appendChild(checkbox);
                        labelEl.appendChild(text);

                        const actions = document.createElement('div');
                        actions.className = 'event-checklist__item-actions';

                        const removeButton = document.createElement('button');
                        removeButton.type = 'button';
                        removeButton.className = 'link-button event-checklist__remove';
                        removeButton.dataset.checklistRemove = item.id;
                        removeButton.textContent = 'Remove';

                        actions.appendChild(removeButton);

                        li.appendChild(labelEl);
                        li.appendChild(actions);
                        list.appendChild(li);
                    });
                }

                list.addEventListener('change', (event) => {
                    const toggle = event.target instanceof Element ? event.target.closest('[data-checklist-toggle]') : null;
                    if (!toggle) {
                        return;
                    }

                    const itemId = toggle.dataset.checklistToggle;
                    store.updateChecklistItem(eventData.id, itemId, { completed: toggle.checked });
                    refreshActiveEvent(eventData.id);
                    renderEvents();
                    renderEventModal();
                });

                list.addEventListener('click', (event) => {
                    const remove = event.target instanceof Element ? event.target.closest('[data-checklist-remove]') : null;
                    if (!remove) {
                        return;
                    }

                    const itemId = remove.dataset.checklistRemove;
                    store.removeChecklistItem(eventData.id, itemId);
                    refreshActiveEvent(eventData.id);
                    renderEvents();
                    renderEventModal();
                });
            }

            if (formEl) {
                const input = formEl.querySelector('input[name="label"]');
                const label = formEl.querySelector('label');
                if (input && label) {
                    const uniqueId = `checklist-${eventData.id}-${Date.now()}`;
                    input.id = uniqueId;
                    label.setAttribute('for', uniqueId);
                }

                formEl.addEventListener('submit', (event) => {
                    event.preventDefault();
                    const formData = new FormData(formEl);
                    const labelValue = (formData.get('label') || '').toString();
                    const created = store.addChecklistItem(eventData.id, labelValue);
                    if (!created) {
                        return;
                    }

                    formEl.reset();
                    refreshActiveEvent(eventData.id);
                    renderEvents();
                    renderEventModal();
                });
            }

            return wrapper;
        }

        function createPrepSheetView(eventData) {
            const fragment = prepSheetTemplate && 'content' in prepSheetTemplate ? prepSheetTemplate.content.cloneNode(true) : null;
            const formEl = fragment ? fragment.querySelector('[data-prep-form]') : null;

            if (!formEl) {
                const fallback = document.createElement('div');
                fallback.className = 'prep-sheet';
                fallback.textContent = 'Prep sheet template unavailable.';
                return fallback;
            }

            const menuField = formEl.querySelector('[name="menu"]');
            const equipmentField = formEl.querySelector('[name="equipment"]');
            const staffingField = formEl.querySelector('[name="staffing"]');
            const statusEl = formEl.querySelector('[data-prep-status]');

            if (menuField) {
                menuField.value = eventData.prepSheet ? eventData.prepSheet.menu || '' : '';
            }
            if (equipmentField) {
                equipmentField.value = eventData.prepSheet ? eventData.prepSheet.equipment || '' : '';
            }
            if (staffingField) {
                staffingField.value = eventData.prepSheet ? eventData.prepSheet.staffing || '' : '';
            }

            formEl.addEventListener('submit', (event) => {
                event.preventDefault();

                const payload = {
                    menu: menuField ? menuField.value.trim() : '',
                    equipment: equipmentField ? equipmentField.value.trim() : '',
                    staffing: staffingField ? staffingField.value.trim() : '',
                };

                store.savePrepSheet(eventData.id, payload);
                refreshActiveEvent(eventData.id);
                renderEvents();

                if (statusEl) {
                    statusEl.textContent = 'Saved';
                    setTimeout(() => {
                        statusEl.textContent = '';
                    }, 2000);
                }
            });

            return formEl;
        }

        function renderEventModal() {
            if (!modal || !modalContentEl || !activeModal) {
                return;
            }

            const eventData = refreshActiveEvent(activeModal.eventId);
            if (!eventData) {
                closeEventModal();
                return;
            }

            const mode = activeModal.mode === 'prep' ? 'prep' : 'checklist';

            if (modalTitleEl) {
                modalTitleEl.textContent = `${eventData.name || 'Event'} · ${mode === 'prep' ? 'Prep sheet' : 'Checklist'}`;
            }
            if (modalSubtitleEl) {
                modalSubtitleEl.textContent = formatModalSubtitle(eventData);
            }

            modalContentEl.innerHTML = '';
            const view = mode === 'prep' ? createPrepSheetView(eventData) : createChecklistView(eventData);
            modalContentEl.appendChild(view);

            modal.classList.add('is-open');
            modal.removeAttribute('hidden');
            document.body.classList.add('modal-open');
        }

        function openEventModal(mode, eventId) {
            if (!modal || !store) {
                return;
            }

            activeModal = {
                mode,
                eventId,
            };

            renderEventModal();
        }

        function closeEventModal() {
            if (!modal) {
                return;
            }

            modal.classList.remove('is-open');
            modal.setAttribute('hidden', '');
            document.body.classList.remove('modal-open');

            if (modalContentEl) {
                modalContentEl.innerHTML = '';
            }

            activeModal = null;
            activeEvent = null;
        }

        function getEventTimestamp(event) {
            if (!event || !event.date) {
                return Number.MAX_SAFE_INTEGER;
            }

            const timestamp = new Date(`${event.date}T${event.time || '00:00'}`).getTime();
            return Number.isNaN(timestamp) ? Number.MAX_SAFE_INTEGER : timestamp;
        }

        function refreshData() {
            if (!store) {
                state.events = [];
                state.employees = [];
                state.employeeMap.clear();
                return;
            }

            state.events = store.getEvents();
            state.employees = store.getEmployees();
            state.employeeMap.clear();
            state.employees.forEach((employee) => {
                state.employeeMap.set(employee.id, employee);
            });
        }

        function getStaffNames(ids) {
            if (!Array.isArray(ids) || ids.length === 0) {
                return [];
            }

            return ids
                .map((id) => state.employeeMap.get(id))
                .filter(Boolean)
                .map((employee) => employee.name);
        }

        function filterEvents(events) {
            switch (state.filter) {
                case 'confirmed':
                    return events.filter((event) => event.statusLevel === 'success');
                case 'pending':
                    return events.filter((event) => event.statusLevel !== 'success');
                case 'drafts':
                    return events.filter((event) => (event.status || '').toLowerCase().includes('draft'));
                default:
                    return events;
            }
        }

        function createBadge(text, level) {
            const badge = document.createElement('span');
            badge.className = `badge ${level || 'neutral'}`;
            badge.textContent = text;
            return badge;
        }

        function getStaffingSummary(event) {
            const names = getStaffNames(event.assignedStaffIds || []);
            const required = typeof event.requiredStaff === 'number' && event.requiredStaff > 0 ? event.requiredStaff : 0;
            const summary = {
                text: event.staffingStatus || 'Unassigned',
                title: event.staffingStatus || 'Unassigned',
            };

            if (names.length) {
                if (required) {
                    summary.text = `${names.length}/${required} assigned`;
                } else {
                    summary.text = `${names.length} assigned`;
                }
                summary.title = names.join(', ');
            }

            return summary;
        }

        function getActionsForEvent(event) {
            const actions = [
                { id: 'view', label: 'View' },
                { id: 'edit', label: 'Modify' },
                { id: 'staff', label: 'Staff' },
                { id: 'notes', label: 'Notes' },
                { id: 'prep', label: 'Prep sheet' },
            ];

            if (event.statusLevel === 'success') {
                actions.push({ id: 'checklist', label: 'Checklist' });
            } else {
                actions.push({ id: 'reminder', label: 'Send reminder' });
            }

            actions.push({ id: 'remove', label: 'Remove', variant: 'danger' });
            return actions;
        }

        function formatRelativeTime(timestamp) {
            if (!timestamp) {
                return 'Never';
            }

            const diff = timestamp - Date.now();
            const minutes = Math.round(diff / (1000 * 60));
            if (Math.abs(minutes) < 60) {
                return relativeFormatter.format(minutes, 'minute');
            }

            const hours = Math.round(diff / (1000 * 60 * 60));
            if (Math.abs(hours) < 24) {
                return relativeFormatter.format(hours, 'hour');
            }

            const days = Math.round(diff / (1000 * 60 * 60 * 24));
            return relativeFormatter.format(days, 'day');
        }

        function renderEvents() {
            if (!tableBody) {
                return;
            }

            tableBody.innerHTML = '';

            if (!store) {
                const row = document.createElement('tr');
                const cell = document.createElement('td');
                cell.colSpan = 7;
                cell.className = 'empty-state';
                cell.textContent = 'Storage service unavailable. Refresh to retry.';
                row.appendChild(cell);
                tableBody.appendChild(row);
                return;
            }

            const events = filterEvents(
                state.events
                    .slice()
                    .sort((a, b) => getEventTimestamp(a) - getEventTimestamp(b))
            );

            if (events.length === 0) {
                const row = document.createElement('tr');
                const cell = document.createElement('td');
                cell.colSpan = 7;
                cell.className = 'empty-state';
                cell.textContent = 'No events match this filter yet. Save one below to get started.';
                row.appendChild(cell);
                tableBody.appendChild(row);
                return;
            }

            events.forEach((event) => {
                const row = document.createElement('tr');
                row.dataset.eventId = event.id;

                const nameCell = document.createElement('td');
                nameCell.textContent = event.name;
                row.appendChild(nameCell);

                const dateCell = document.createElement('td');
                dateCell.textContent = formatDate(event.date, event.time);
                row.appendChild(dateCell);

                const locationCell = document.createElement('td');
                locationCell.textContent = event.location || 'Location TBC';
                row.appendChild(locationCell);

                const packageCell = document.createElement('td');
                const packageParts = [];
                if (event.package) {
                    packageParts.push(event.package);
                }
                if (event.guestCount) {
                    packageParts.push(`${event.guestCount} guests`);
                }
                if (typeof event.payout === 'number' && event.payout > 0) {
                    packageParts.push(formatCurrency(event.payout));
                }
                packageCell.textContent = packageParts.join(' · ') || 'Package TBC';
                row.appendChild(packageCell);

                const statusCell = document.createElement('td');
                statusCell.appendChild(createBadge(event.status || 'Pending', event.statusLevel));
                row.appendChild(statusCell);

                const staffingCell = document.createElement('td');
                const staffingSummary = getStaffingSummary(event);
                const staffingBadge = createBadge(staffingSummary.text, event.staffingLevel);
                staffingBadge.title = staffingSummary.title;
                staffingCell.appendChild(staffingBadge);
                row.appendChild(staffingCell);

                const actionsCell = document.createElement('td');
                actionsCell.className = 'table-actions';

                getActionsForEvent(event).forEach((action) => {
                    const button = document.createElement('button');
                    button.type = 'button';
                    button.className = 'card-action link-button';
                    if (action.variant === 'danger') {
                        button.classList.add('card-action--danger');
                    }
                    button.dataset.action = action.id;
                    button.dataset.eventId = event.id;
                    button.textContent = action.label;
                    actionsCell.appendChild(button);
                });

                row.appendChild(actionsCell);
                tableBody.appendChild(row);
            });
        }

        function handleViewEvent(eventData) {
            const wrapper = document.createElement('div');
            wrapper.className = 'modal-section';

            const list = document.createElement('dl');
            list.className = 'modal-summary';

            const addEntry = (label, value) => {
                const dt = document.createElement('dt');
                dt.textContent = label;
                const dd = document.createElement('dd');
                dd.textContent = value;
                list.appendChild(dt);
                list.appendChild(dd);
            };

            addEntry('Date', formatDate(eventData.date, eventData.time));
            addEntry('Location', eventData.location || 'Not set');
            addEntry('Package', eventData.package || 'Not set');
            addEntry('Guests', eventData.guestCount ? String(eventData.guestCount) : 'Not set');
            addEntry('Payout', eventData.payout ? formatCurrency(eventData.payout) : 'Not set');
            addEntry('Status', eventData.status || 'Pending');

            const staffingSummary = getStaffingSummary(eventData);
            addEntry('Staffing', staffingSummary.text);
            addEntry('Last reminder', eventData.lastReminderSent ? `${formatRelativeTime(eventData.lastReminderSent)} · ${dateTimeFormatter.format(new Date(eventData.lastReminderSent))}` : 'Never');

            wrapper.appendChild(list);

            const notesHeading = document.createElement('h4');
            notesHeading.textContent = 'Notes';
            notesHeading.className = 'modal-subheading';
            wrapper.appendChild(notesHeading);

            const notes = document.createElement('p');
            notes.className = 'modal-notes';
            notes.textContent = eventData.notes ? eventData.notes : 'No notes yet.';
            wrapper.appendChild(notes);

            openBackdropModal({
                title: eventData.name,
                body: wrapper,
                actions: [{ label: 'Close', variant: 'primary', onClick: closeBackdropModal }],
            });
        }

        function handleStaffEvent(eventData) {
            const formElement = document.createElement('form');
            formElement.className = 'modal-form';

            const helper = document.createElement('p');
            helper.className = 'form-helper';
            const required = typeof eventData.requiredStaff === 'number' && eventData.requiredStaff > 0 ? eventData.requiredStaff : 0;
            helper.textContent = required
                ? `Select up to ${required} team member${required === 1 ? '' : 's'}.`
                : 'Select the team members you want to assign.';
            formElement.appendChild(helper);

            const list = document.createElement('div');
            list.className = 'staff-picker';
            formElement.appendChild(list);

            const assignedSet = new Set(eventData.assignedStaffIds || []);

            if (state.employees.length === 0) {
                const empty = document.createElement('p');
                empty.className = 'empty-state';
                empty.textContent = 'Add team members first to assign staffing.';
                formElement.appendChild(empty);
            }

            state.employees.forEach((employee) => {
                const label = document.createElement('label');
                label.className = 'staff-picker__item';

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.name = 'staffMembers';
                checkbox.value = employee.id;
                checkbox.checked = assignedSet.has(employee.id);

                const name = document.createElement('span');
                name.className = 'staff-picker__name';
                name.textContent = employee.name;

                const role = document.createElement('span');
                role.className = 'staff-picker__meta';
                role.textContent = employee.role || '';

                const status = document.createElement('span');
                status.className = `badge ${employee.statusLevel || 'neutral'}`;
                status.textContent = employee.status || 'Status TBC';

                label.appendChild(checkbox);
                label.appendChild(name);
                label.appendChild(role);
                label.appendChild(status);

                list.appendChild(label);
            });

            formElement.addEventListener('submit', (event) => {
                event.preventDefault();
                if (!store) {
                    return;
                }

                const selected = Array.from(formElement.querySelectorAll('input[name="staffMembers"]:checked')).map((input) => input.value);
                store.assignStaff(eventData.id, selected);
                closeBackdropModal();
                showToast('Staff assignments saved', 'success');
                refreshData();
                renderEvents();
            });

            openBackdropModal({
                title: `Assign staff · ${eventData.name}`,
                body: formElement,
                actions: [
                    { label: 'Cancel', variant: 'ghost', onClick: closeBackdropModal },
                    { label: 'Save assignments', variant: 'primary', onClick: () => formElement.requestSubmit() },
                ],
            });

            const firstCheckbox = formElement.querySelector('input[type="checkbox"]');
            if (firstCheckbox) {
                firstCheckbox.focus();
            }
        }

        function handleNotesEvent(eventData) {
            const formElement = document.createElement('form');
            formElement.className = 'modal-form';

            const label = document.createElement('label');
            label.className = 'form-field';
            const span = document.createElement('span');
            span.textContent = 'Notes';
            const textarea = document.createElement('textarea');
            textarea.name = 'notes';
            textarea.rows = 6;
            textarea.value = eventData.notes || '';
            label.appendChild(span);
            label.appendChild(textarea);

            formElement.appendChild(label);

            const helper = document.createElement('p');
            helper.className = 'form-helper';
            helper.textContent = 'Saved notes appear in the calendar day view.';
            formElement.appendChild(helper);

            formElement.addEventListener('submit', (event) => {
                event.preventDefault();
                if (!store) {
                    return;
                }

                const nextNotes = textarea.value.trim();
                store.updateEvent(eventData.id, { notes: nextNotes });
                closeBackdropModal();
                showToast('Notes saved', 'success');
                refreshData();
                renderEvents();
            });

            openBackdropModal({
                title: `Notes · ${eventData.name}`,
                body: formElement,
                actions: [
                    { label: 'Cancel', variant: 'ghost', onClick: closeBackdropModal },
                    { label: 'Save notes', variant: 'primary', onClick: () => formElement.requestSubmit() },
                ],
            });

            textarea.focus();
        }

        function handleReminderEvent(eventData) {
            const formElement = document.createElement('form');
            formElement.className = 'modal-form';

            const info = document.createElement('p');
            info.className = 'form-helper';
            info.textContent = eventData.lastReminderSent
                ? `Last reminder ${formatRelativeTime(eventData.lastReminderSent)} (${dateTimeFormatter.format(new Date(eventData.lastReminderSent))}).`
                : 'No reminders have been logged for this event yet.';
            formElement.appendChild(info);

            const label = document.createElement('label');
            label.className = 'form-field';
            const span = document.createElement('span');
            span.textContent = 'Message';
            const textarea = document.createElement('textarea');
            textarea.name = 'reminderMessage';
            textarea.rows = 5;
            const friendlyDate = formatDate(eventData.date, eventData.time);
            textarea.value = `Hi there! Checking in on ${eventData.name} scheduled for ${friendlyDate}. Let me know if you have any updates.`;
            label.appendChild(span);
            label.appendChild(textarea);
            formElement.appendChild(label);

            formElement.addEventListener('submit', (event) => {
                event.preventDefault();
                if (!store) {
                    return;
                }

                const message = textarea.value.trim();
                const timestamp = Date.now();
                const existingNotes = eventData.notes ? `${eventData.notes}\n\n` : '';
                const nextNotes = message
                    ? `${existingNotes}Reminder logged ${dateTimeFormatter.format(new Date(timestamp))}: ${message}`
                    : eventData.notes || '';

                store.updateEvent(eventData.id, {
                    lastReminderSent: timestamp,
                    notes: nextNotes,
                });
                closeBackdropModal();
                showToast('Reminder logged', 'success');
                refreshData();
                renderEvents();
            });

            openBackdropModal({
                title: `Send reminder · ${eventData.name}`,
                body: formElement,
                actions: [
                    { label: 'Cancel', variant: 'ghost', onClick: closeBackdropModal },
                    { label: 'Log reminder', variant: 'primary', onClick: () => formElement.requestSubmit() },
                ],
            });

            textarea.focus();
        }

        function handleChecklistEvent(eventData) {
            const wrapper = document.createElement('div');
            wrapper.className = 'modal-section';

            const intro = document.createElement('p');
            intro.className = 'form-helper';
            intro.textContent = 'Mark tasks as you prep. Progress is saved while this window stays open.';
            wrapper.appendChild(intro);

            const assignedNames = getStaffNames(eventData.assignedStaffIds || []);
            const staffLabel = assignedNames.length ? assignedNames.join(', ') : 'assigned staff';
            const tasks = [
                `Confirm call times with ${staffLabel}.`,
                `Review the menu for ${eventData.package || 'the selected package'}.`,
                'Finalize the shopping list and rentals.',
                'Send arrival instructions to the client.',
            ];

            const list = document.createElement('ul');
            list.className = 'checklist';
            wrapper.appendChild(list);

            tasks.forEach((task, index) => {
                const item = document.createElement('li');
                const label = document.createElement('label');
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.dataset.index = String(index);
                const text = document.createElement('span');
                text.textContent = task;
                label.appendChild(checkbox);
                label.appendChild(text);
                item.appendChild(label);
                list.appendChild(item);
            });

            const progress = document.createElement('p');
            progress.className = 'form-helper';
            wrapper.appendChild(progress);

            const updateProgress = () => {
                const total = tasks.length;
                const done = list.querySelectorAll('input[type="checkbox"]:checked').length;
                progress.textContent = `${done}/${total} tasks complete`;
            };

            list.addEventListener('change', updateProgress);
            updateProgress();

            openBackdropModal({
                title: `Checklist · ${eventData.name}`,
                body: wrapper,
                actions: [{ label: 'Close', variant: 'primary', onClick: closeBackdropModal }],
            });

            const firstCheckbox = list.querySelector('input[type="checkbox"]');
            if (firstCheckbox) {
                firstCheckbox.focus();
            }
        }

        if (tabs.length) {
            tabs.forEach((tab) => {
                tab.addEventListener('click', () => {
                    tabs.forEach((button) => button.classList.remove('active'));
                    tab.classList.add('active');
                    state.filter = tab.dataset.filter || 'all';
                    renderEvents();
                });
            });
        }

        if (tableBody) {
            tableBody.addEventListener('click', (event) => {
                if (!(event.target instanceof Element)) {
                    return;
                }

                const actionButton = event.target.closest('[data-action]');
                if (!actionButton) {
                    return;
                }

                event.preventDefault();

                const action = actionButton.dataset.action;
                const eventId = actionButton.dataset.eventId;
                if (!action || !eventId) {
                    return;
                }

                const eventData = state.events.find((item) => item.id === eventId);
                if (!eventData) {
                    return;
                }

                if (!store) {
                    showToast('Storage unavailable right now.', 'error');
                    return;
                }

                switch (action) {
                    case 'view':
                        handleViewEvent(eventData);
                        break;
                    case 'edit':
                        enterEditMode(eventData);
                        break;
                    case 'staff':
                        handleStaffEvent(eventData);
                        break;
                    case 'notes':
                        handleNotesEvent(eventData);
                        break;
                    case 'reminder':
                        handleReminderEvent(eventData);
                        break;
                    case 'prep':
                        if (modal) {
                            openEventModal('prep', eventId);
                        } else {
                            const message = document.createElement('p');
                            message.className = 'empty-state';
                            message.textContent = 'Prep sheet is unavailable in this view.';
                            openBackdropModal({
                                title: `Prep sheet · ${eventData.name}`,
                                body: message,
                                actions: [{ label: 'Close', variant: 'primary', onClick: closeBackdropModal }],
                            });
                        }
                        break;
                    case 'checklist':
                        if (modal) {
                            openEventModal('checklist', eventId);
                        } else {
                            handleChecklistEvent(eventData);
                        }
                        break;
                    case 'remove':
                        store.removeEvent(eventId);
                        if (activeModal && activeModal.eventId === eventId) {
                            closeEventModal();
                        }
                        showToast('Event removed', 'success');
                        refreshData();
                        renderEvents();
                        if (editingEventId === eventId) {
                            exitEditMode();
                            applyDefaultSelects();
                        }
                        break;
                    default:
                        break;
                }
            });
        }

        if (modal) {
            modal.addEventListener('click', (event) => {
                if (!(event.target instanceof Element)) {
                    return;
                }

                if (event.target.closest('[data-modal-dismiss]')) {
                    closeEventModal();
                }
            });
        }

        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape' && modal && modal.classList.contains('is-open')) {
                closeEventModal();
            }
        });

        function applyDefaultSelects() {
            if (!form) {
                return;
            }

            if (form.eventStatus) {
                form.eventStatus.value = defaultStatusValue;
            }
            if (form.eventStaffing) {
                form.eventStaffing.value = defaultStaffingValue;
            }
        }

        function ensureOption(select, value, level) {
            if (!select || value === undefined || value === null || value === '') {
                return;
            }

            const option = Array.from(select.options || []).find((opt) => opt.value === value);
            if (option) {
                if (level && option.dataset) {
                    option.dataset.level = level;
                }
                select.value = value;
                return;
            }

            const newOption = document.createElement('option');
            newOption.value = value;
            newOption.textContent = value;
            if (level) {
                newOption.dataset.level = level;
            }
            select.appendChild(newOption);
            select.value = value;
        }

        function updateModeIndicator(message) {
            if (!modeIndicator) {
                return;
            }

            modeIndicator.textContent = message || '';
        }

        function exitEditMode() {
            editingEventId = null;
            if (hiddenIdField) {
                hiddenIdField.value = '';
            }
            if (submitButton) {
                submitButton.textContent = 'Save event';
            }
            if (form) {
                form.dataset.mode = 'create';
            }
            updateModeIndicator('');
        }

        function enterEditMode(eventData) {
            if (!form) {
                return;
            }

            editingEventId = eventData.id;
            if (hiddenIdField) {
                hiddenIdField.value = eventData.id;
            }

            form.dataset.mode = 'edit';

            if (form.eventName) {
                form.eventName.value = eventData.name || '';
            }
            if (form.eventDate) {
                form.eventDate.value = eventData.date || '';
            }
            if (form.eventTime) {
                form.eventTime.value = eventData.time || '';
            }
            if (form.eventLocation) {
                form.eventLocation.value = eventData.location || '';
            }
            if (form.eventPackage) {
                ensureOption(form.eventPackage, eventData.package);
            }
            if (form.guestCount) {
                form.guestCount.value = eventData.guestCount != null ? eventData.guestCount : '';
            }
            if (form.eventPayout) {
                form.eventPayout.value = eventData.payout != null ? eventData.payout : '';
            }
            if (form.eventStatus) {
                ensureOption(form.eventStatus, eventData.status, eventData.statusLevel);
            }
            if (form.eventStaffing) {
                ensureOption(form.eventStaffing, eventData.staffingStatus, eventData.staffingLevel);
            }
            if (form.eventNotes) {
                form.eventNotes.value = eventData.notes || '';
            }

            if (submitButton) {
                submitButton.textContent = 'Update event';
            }

            const nameText = eventData.name ? `Editing "${eventData.name}"` : 'Editing existing event';
            updateModeIndicator(nameText);
            if (typeof window !== 'undefined') {
                window.location.hash = '#new-event';
            }
        }

        if (form && store) {
            form.addEventListener('submit', (event) => {
                event.preventDefault();

                const formData = new FormData(form);
                const statusSelect = form.eventStatus;
                const staffingSelect = form.eventStaffing;
                const statusOption = statusSelect ? statusSelect.options[statusSelect.selectedIndex] : null;
                const staffingOption = staffingSelect ? staffingSelect.options[staffingSelect.selectedIndex] : null;

                const eventPayload = {
                    name: (formData.get('name') || '').trim() || 'Untitled event',
                    date: formData.get('date') || '',
                    time: formData.get('time') || '',
                    location: (formData.get('location') || '').trim(),
                    package: formData.get('package') || '',
                    guestCount: Number(formData.get('guestCount') || 0),
                    payout: Number(formData.get('payout') || 0),
                    requiredStaff: Number(formData.get('requiredStaff') || 0),
                    status: formData.get('status') || (statusSelect ? statusSelect.value : defaultStatusValue) || 'Draft',
                    statusLevel: statusOption ? statusOption.dataset.level : undefined,
                    staffingStatus:
                        formData.get('staffingStatus') ||
                        (staffingSelect ? staffingSelect.value : defaultStaffingValue) ||
                        'Unassigned',
                    staffingLevel: staffingOption ? staffingOption.dataset.level : undefined,
                    notes: (formData.get('notes') || '').trim(),
                };

                const isEdit = Boolean(editingEventId);
                if (isEdit) {
                    store.updateEvent(editingEventId, eventPayload);
                } else {
                    store.addEvent(eventPayload);
                }

                const toastMessage = isEdit ? 'Event updated' : 'Event saved';

                form.reset();
                exitEditMode();
                applyDefaultSelects();

                showToast(toastMessage, 'success');

                refreshData();
                renderEvents();
            });

            form.addEventListener('reset', () => {
                const resetHandler = () => {
                    exitEditMode();
                    applyDefaultSelects();
                };

                if (typeof window !== 'undefined' && window.requestAnimationFrame) {
                    window.requestAnimationFrame(resetHandler);
                } else {
                    resetHandler();
                }
            });
        }

        exitEditMode();
        applyDefaultSelects();
        refreshData();
        renderEvents();
    </script>

    <script src="app.js"></script>
</body>
</html>
