<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Events - Bartending2U</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="styles.css" />
</head>
<body>
    <header class="top-bar">
        <div class="top-bar__inner">
            <div class="brand">
                <img src="IMG_9047.png" alt="Bartending2U logo" />
                <div class="brand__text">
                    <span class="brand__subtitle">Bartending2U</span>
                    <span class="brand__title">Scheduling Suite</span>
                </div>
            </div>

            <button
                class="mobile-nav-toggle"
                id="mobileNavToggle"
                type="button"
                aria-label="Toggle navigation"
                aria-expanded="false"
                data-mobile-nav-toggle
            >
                <span class="mobile-nav-toggle__icon" aria-hidden="true">☰</span>
                <span class="sr-only">Toggle navigation</span>
            </button>

            <nav class="nav-links" id="primaryNav">
                <a class="nav-link" href="index.html">Dashboard</a>
                <a class="nav-link active" href="events.html">Events</a>
                <a class="nav-link" href="leads.html">Leads</a>
                <a class="nav-link" href="employees.html">Employees</a>
                <a class="nav-link" href="calendar.html">Calendar</a>
                <a class="nav-link" href="settings.html">Settings</a>
            </nav>

            <a class="cta-button" href="#new-event">+ New Event</a>
        </div>
    </header>

    <main class="page-content">
        <section class="page-header">
            <div>
                <p class="page-eyebrow">Events</p>
                <h1 class="page-title">Booked experiences & proposals</h1>
                <p class="lead-text">Glance through every celebration, from contracted events to pending tastings, and manage staffing in one place.</p>
            </div>
            <div class="hero-actions">
                <a class="button primary" href="#new-event" data-subsection-target="new-event">Log new booking</a>
                <a class="secondary-link" href="calendar.html">Sync with calendar →</a>
            </div>
        </section>

        <section id="event-pipeline" class="content-card" data-subsection="Event pipeline">
            <div class="card-header">
                <div>
                    <h2 class="card-title">Event pipeline</h2>
                    <p class="card-subtitle">Filter the engagements you care about and track readiness at a glance.</p>
                </div>
            </div>
            <div class="tab-bar">
                <button class="tab active" type="button" data-filter="all">All</button>
                <button class="tab" type="button" data-filter="confirmed">Confirmed</button>
                <button class="tab" type="button" data-filter="pending">Pending</button>
                <button class="tab" type="button" data-filter="drafts">Drafts</button>
            </div>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>Event</th>
                            <th>Date</th>
                            <th>Location</th>
                            <th>Package</th>
                            <th>Status</th>
                            <th>Staffing</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="eventsTableBody"></tbody>
                </table>
            </div>
        </section>

        <section id="new-event" class="content-card" data-subsection="Create new event">
            <div class="card-header">
                <div>
                    <h2 class="card-title">Create new event</h2>
                    <p class="card-subtitle">Capture the essentials, assign talent, and keep clients delighted.</p>
                </div>
            </div>
            <form id="eventForm">
                <div class="form-grid">
                    <div class="form-field">
                        <label for="eventName">Event name</label>
                        <input id="eventName" name="name" type="text" placeholder="E.g. Winter Soirée" required />
                    </div>
                    <div class="form-field">
                        <label for="eventDate">Date</label>
                        <input id="eventDate" name="date" type="date" required />
                    </div>
                    <div class="form-field">
                        <label for="eventTime">Start time</label>
                        <input id="eventTime" name="time" type="time" />
                    </div>
                    <div class="form-field">
                        <label for="eventLocation">Location</label>
                        <input id="eventLocation" name="location" type="text" placeholder="Venue or address" />
                    </div>
                    <div class="form-field">
                        <label for="eventPackage">Service package</label>
                        <select id="eventPackage" name="package" required>
                            <option value="" selected disabled>Select package</option>
                            <option>Signature Cocktail Bar</option>
                            <option>Premium Mixology</option>
                            <option>Interactive Workshop</option>
                            <option>Custom Experience</option>
                        </select>
                    </div>
                    <div class="form-field">
                        <label for="guestCount">Guest count</label>
                        <input id="guestCount" name="guestCount" type="number" min="0" placeholder="Expected attendees" />
                    </div>
                    <div class="form-field">
                        <label for="eventPayout">Estimated payout (USD)</label>
                        <input id="eventPayout" name="payout" type="number" min="0" step="50" placeholder="0" />
                    </div>
                </div>
                <div class="form-grid">
                    <div class="form-field">
                        <label for="eventStatus">Event status</label>
                        <select id="eventStatus" name="status" required>
                            <option value="" disabled>Select status</option>
                            <option value="Confirmed" data-level="success" selected>Confirmed</option>
                            <option value="Awaiting deposit" data-level="warning">Awaiting deposit</option>
                            <option value="Contract overdue" data-level="danger">Contract overdue</option>
                            <option value="Proposal sent" data-level="info">Proposal sent</option>
                            <option value="Draft" data-level="neutral">Draft</option>
                        </select>
                    </div>
                    <div class="form-field">
                        <label for="eventStaffing">Staffing status</label>
                        <select id="eventStaffing" name="staffingStatus" required>
                            <option value="" disabled>Select staffing</option>
                            <option value="Fully staffed" data-level="success" selected>Fully staffed</option>
                            <option value="Ready" data-level="success">Ready</option>
                            <option value="Needs 1 bartender" data-level="warning">Needs 1 bartender</option>
                            <option value="Needs 2 bartenders" data-level="warning">Needs 2 bartenders</option>
                            <option value="Unassigned" data-level="danger">Unassigned</option>
                        </select>
                    </div>
                </div>
                <div class="form-field">
                    <label for="eventNotes">Notes & client preferences</label>
                    <textarea id="eventNotes" name="notes" placeholder="Share tastings, specialty cocktails, or logistics."></textarea>
                </div>
                <div class="table-actions" style="justify-content: flex-end;">
                    <button class="button ghost" type="reset">Clear</button>
                    <button class="button primary" type="submit">Save event</button>
                </div>
            </form>
        </section>

        <div id="eventModal" class="modal" hidden>
            <div class="modal__backdrop" data-modal-dismiss></div>
            <div class="modal__panel" role="dialog" aria-modal="true" aria-labelledby="eventModalTitle">
                <button class="modal__close" type="button" aria-label="Close" data-modal-dismiss>&times;</button>
                <div class="modal__header">
                    <h3 class="modal__title" id="eventModalTitle"></h3>
                    <p class="modal__subtitle" data-modal-subtitle></p>
                </div>
                <div class="modal__content" data-modal-content></div>
            </div>
        </div>

        <template id="checklistTemplate">
            <div class="event-checklist">
                <ul class="event-checklist__items" data-checklist-items></ul>
                <form class="event-checklist__form" data-checklist-form>
                    <label class="sr-only" for="checklistNewItem">Add checklist item</label>
                    <input id="checklistNewItem" name="label" type="text" placeholder="Add new item" required autocomplete="off" />
                    <button class="button primary" type="submit">Add</button>
                </form>
            </div>
        </template>

        <template id="prepSheetTemplate">
            <form class="prep-sheet" data-prep-form>
                <div class="prep-sheet__fields">
                    <label class="form-field">
                        <span class="form-field__label">Menu focus</span>
                        <textarea name="menu" rows="3" placeholder="Signature cocktails, mocktail options, etc."></textarea>
                    </label>
                    <label class="form-field">
                        <span class="form-field__label">Equipment & logistics</span>
                        <textarea name="equipment" rows="3" placeholder="Bar kits, glassware counts, load-in notes"></textarea>
                    </label>
                    <label class="form-field">
                        <span class="form-field__label">Staffing notes</span>
                        <textarea name="staffing" rows="3" placeholder="Arrival times, attire, assignments"></textarea>
                    </label>
                </div>
                <div class="prep-sheet__actions">
                    <span class="prep-sheet__status" aria-live="polite" data-prep-status></span>
                    <button class="button primary" type="submit">Save prep sheet</button>
                </div>
            </form>
        </template>
    </main>

    <footer class="app-footer">© 2025 Bartending2U. Crafted for seamless event coordination.</footer>

    <script src="scripts.js"></script>
    <script src="storage.js"></script>
    <script>
        const navToggle = document.getElementById('mobileNavToggle');
        const nav = document.getElementById('primaryNav');

        if (navToggle && nav) {
            navToggle.addEventListener('click', () => {
                nav.classList.toggle('open');
            });
        }

        const store = window.B2UStore;
        const tableBody = document.getElementById('eventsTableBody');
        const form = document.getElementById('eventForm');
        const tabs = document.querySelectorAll('.tab');
        let activeFilter = 'all';
        const modal = document.getElementById('eventModal');
        const modalTitleEl = modal ? modal.querySelector('#eventModalTitle') : null;
        const modalSubtitleEl = modal ? modal.querySelector('[data-modal-subtitle]') : null;
        const modalContentEl = modal ? modal.querySelector('[data-modal-content]') : null;
        const checklistTemplate = document.getElementById('checklistTemplate');
        const prepSheetTemplate = document.getElementById('prepSheetTemplate');
        let activeModal = null;
        let activeEvent = null;

        function formatDate(dateStr, timeStr) {
            if (!dateStr) {
                return 'Date TBC';
            }

            const date = new Date(`${dateStr}T${timeStr || '12:00'}`);
            if (Number.isNaN(date.getTime())) {
                return 'Date TBC';
            }

            return new Intl.DateTimeFormat('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric',
                hour: timeStr ? 'numeric' : undefined,
                minute: timeStr ? '2-digit' : undefined,
            }).format(date);
        }

        function formatCurrency(amount) {
            if (!amount && amount !== 0) {
                return '$0';
            }

            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                maximumFractionDigits: 0,
            }).format(amount);
        }

        function createBadge(text, level) {
            const badge = document.createElement('span');
            badge.className = `badge ${level || 'neutral'}`;
            badge.textContent = text;
            return badge;
        }

        function formatModalSubtitle(event) {
            if (!event) {
                return '';
            }

            const parts = [];
            if (event.date) {
                parts.push(formatDate(event.date, event.time));
            }
            if (event.location) {
                parts.push(event.location);
            }
            return parts.join(' • ');
        }

        function refreshActiveEvent(eventId) {
            if (!store) {
                return null;
            }

            const idToFetch = eventId || (activeModal && activeModal.eventId);
            if (!idToFetch) {
                return null;
            }

            const next = store.getEvent(idToFetch);
            if (next) {
                activeEvent = next;
            }
            return next;
        }

        function createChecklistView(eventData) {
            const fragment = checklistTemplate && 'content' in checklistTemplate ? checklistTemplate.content.cloneNode(true) : null;
            const wrapper = fragment ? fragment.querySelector('.event-checklist') : document.createElement('div');

            if (!fragment) {
                wrapper.className = 'event-checklist';
                wrapper.innerHTML = '<ul class="event-checklist__items" data-checklist-items></ul>';
            }

            const list = wrapper.querySelector('[data-checklist-items]');
            const formEl = wrapper.querySelector('[data-checklist-form]');

            if (list) {
                list.innerHTML = '';
                const items = Array.isArray(eventData.checklist) ? eventData.checklist : [];

                if (!items.length) {
                    const empty = document.createElement('li');
                    empty.className = 'event-checklist__empty';
                    empty.textContent = 'No checklist items yet. Add one to get started.';
                    list.appendChild(empty);
                } else {
                    items.forEach((item) => {
                        const li = document.createElement('li');
                        li.className = 'event-checklist__item';
                        li.dataset.itemId = item.id;
                        if (item.completed) {
                            li.classList.add('is-complete');
                        }

                        const checkboxId = `${eventData.id}-${item.id}`;
                        const labelEl = document.createElement('label');
                        labelEl.className = 'checkbox-field';
                        labelEl.setAttribute('for', checkboxId);

                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.id = checkboxId;
                        checkbox.checked = Boolean(item.completed);
                        checkbox.dataset.checklistToggle = item.id;

                        const text = document.createElement('span');
                        text.textContent = item.label;

                        labelEl.appendChild(checkbox);
                        labelEl.appendChild(text);

                        const actions = document.createElement('div');
                        actions.className = 'event-checklist__item-actions';

                        const removeButton = document.createElement('button');
                        removeButton.type = 'button';
                        removeButton.className = 'link-button event-checklist__remove';
                        removeButton.dataset.checklistRemove = item.id;
                        removeButton.textContent = 'Remove';

                        actions.appendChild(removeButton);

                        li.appendChild(labelEl);
                        li.appendChild(actions);
                        list.appendChild(li);
                    });
                }

                list.addEventListener('change', (event) => {
                    const toggle = event.target instanceof Element ? event.target.closest('[data-checklist-toggle]') : null;
                    if (!toggle) {
                        return;
                    }

                    const itemId = toggle.dataset.checklistToggle;
                    store.updateChecklistItem(eventData.id, itemId, { completed: toggle.checked });
                    refreshActiveEvent(eventData.id);
                    renderEvents();
                    renderModal();
                });

                list.addEventListener('click', (event) => {
                    const remove = event.target instanceof Element ? event.target.closest('[data-checklist-remove]') : null;
                    if (!remove) {
                        return;
                    }

                    const itemId = remove.dataset.checklistRemove;
                    store.removeChecklistItem(eventData.id, itemId);
                    refreshActiveEvent(eventData.id);
                    renderEvents();
                    renderModal();
                });
            }

            if (formEl) {
                const input = formEl.querySelector('input[name="label"]');
                const label = formEl.querySelector('label');
                if (input && label) {
                    const uniqueId = `checklist-${eventData.id}-${Date.now()}`;
                    input.id = uniqueId;
                    label.setAttribute('for', uniqueId);
                }

                formEl.addEventListener('submit', (event) => {
                    event.preventDefault();
                    const formData = new FormData(formEl);
                    const labelValue = (formData.get('label') || '').toString();
                    const created = store.addChecklistItem(eventData.id, labelValue);
                    if (!created) {
                        return;
                    }

                    formEl.reset();
                    refreshActiveEvent(eventData.id);
                    renderEvents();
                    renderModal();
                });
            }

            return wrapper;
        }

        function createPrepSheetView(eventData) {
            const fragment = prepSheetTemplate && 'content' in prepSheetTemplate ? prepSheetTemplate.content.cloneNode(true) : null;
            const formEl = fragment ? fragment.querySelector('[data-prep-form]') : null;

            if (!formEl) {
                const fallback = document.createElement('div');
                fallback.className = 'prep-sheet';
                fallback.textContent = 'Prep sheet template unavailable.';
                return fallback;
            }

            const menuField = formEl.querySelector('[name="menu"]');
            const equipmentField = formEl.querySelector('[name="equipment"]');
            const staffingField = formEl.querySelector('[name="staffing"]');
            const statusEl = formEl.querySelector('[data-prep-status]');

            if (menuField) {
                menuField.value = eventData.prepSheet ? eventData.prepSheet.menu || '' : '';
            }
            if (equipmentField) {
                equipmentField.value = eventData.prepSheet ? eventData.prepSheet.equipment || '' : '';
            }
            if (staffingField) {
                staffingField.value = eventData.prepSheet ? eventData.prepSheet.staffing || '' : '';
            }

            formEl.addEventListener('submit', (event) => {
                event.preventDefault();

                const payload = {
                    menu: menuField ? menuField.value.trim() : '',
                    equipment: equipmentField ? equipmentField.value.trim() : '',
                    staffing: staffingField ? staffingField.value.trim() : '',
                };

                store.savePrepSheet(eventData.id, payload);
                refreshActiveEvent(eventData.id);
                renderEvents();

                if (statusEl) {
                    statusEl.textContent = 'Saved';
                    setTimeout(() => {
                        statusEl.textContent = '';
                    }, 2000);
                }
            });

            return formEl;
        }

        function renderModal() {
            if (!modal || !modalContentEl || !activeModal) {
                return;
            }

            const eventData = refreshActiveEvent(activeModal.eventId);
            if (!eventData) {
                closeModal();
                return;
            }

            const mode = activeModal.mode === 'prep' ? 'prep' : 'checklist';

            if (modalTitleEl) {
                modalTitleEl.textContent = `${eventData.name || 'Event'} · ${mode === 'prep' ? 'Prep sheet' : 'Checklist'}`;
            }
            if (modalSubtitleEl) {
                modalSubtitleEl.textContent = formatModalSubtitle(eventData);
            }

            modalContentEl.innerHTML = '';
            const view = mode === 'prep' ? createPrepSheetView(eventData) : createChecklistView(eventData);
            modalContentEl.appendChild(view);

            modal.classList.add('is-open');
            modal.removeAttribute('hidden');
            document.body.classList.add('modal-open');
        }

        function openModal(mode, eventId) {
            if (!modal || !store) {
                return;
            }

            activeModal = {
                mode,
                eventId,
            };

            renderModal();
        }

        function closeModal() {
            if (!modal) {
                return;
            }

            modal.classList.remove('is-open');
            modal.setAttribute('hidden', '');
            document.body.classList.remove('modal-open');

            if (modalContentEl) {
                modalContentEl.innerHTML = '';
            }

            activeModal = null;
            activeEvent = null;
        }

        function getEventTimestamp(event) {
            if (!event || !event.date) {
                return Number.MAX_SAFE_INTEGER;
            }

            const timestamp = new Date(`${event.date}T${event.time || '00:00'}`).getTime();
            return Number.isNaN(timestamp) ? Number.MAX_SAFE_INTEGER : timestamp;
        }

        function filterEvents(events) {
            switch (activeFilter) {
                case 'confirmed':
                    return events.filter((event) => event.statusLevel === 'success');
                case 'pending':
                    return events.filter((event) => event.statusLevel !== 'success');
                case 'drafts':
                    return events.filter((event) => (event.status || '').toLowerCase().includes('draft'));
                default:
                    return events;
            }
        }

        function renderEvents() {
            if (!tableBody) {
                return;
            }

            tableBody.innerHTML = '';

            if (!store) {
                const row = document.createElement('tr');
                const cell = document.createElement('td');
                cell.colSpan = 7;
                cell.className = 'empty-state';
                cell.textContent = 'Storage service unavailable. Refresh to retry.';
                row.appendChild(cell);
                tableBody.appendChild(row);
                return;
            }

            const events = filterEvents(
                store
                    .getEvents()
                    .slice()
                    .sort((a, b) => getEventTimestamp(a) - getEventTimestamp(b))
            );

            if (events.length === 0) {
                const row = document.createElement('tr');
                const cell = document.createElement('td');
                cell.colSpan = 7;
                cell.className = 'empty-state';
                cell.textContent = 'No events match this filter yet. Save one below to get started.';
                row.appendChild(cell);
                tableBody.appendChild(row);
                return;
            }

            events.forEach((event) => {
                const row = document.createElement('tr');

                const nameCell = document.createElement('td');
                nameCell.textContent = event.name;

                const dateCell = document.createElement('td');
                dateCell.textContent = formatDate(event.date, event.time);

                const locationCell = document.createElement('td');
                locationCell.textContent = event.location || 'Location TBC';

                const packageCell = document.createElement('td');
                const packageParts = [];
                if (event.package) {
                    packageParts.push(event.package);
                }
                if (event.guestCount) {
                    packageParts.push(`${event.guestCount} guests`);
                }
                if (event.payout) {
                    packageParts.push(formatCurrency(event.payout));
                }
                packageCell.textContent = packageParts.join(' · ') || 'Package TBC';

                const statusCell = document.createElement('td');
                statusCell.appendChild(createBadge(event.status || 'Pending', event.statusLevel));

                const staffingCell = document.createElement('td');
                staffingCell.appendChild(createBadge(event.staffingStatus || 'Unassigned', event.staffingLevel));

                const actionsCell = document.createElement('td');
                actionsCell.className = 'table-actions';

                const viewLink = document.createElement('a');
                viewLink.className = 'card-action';
                viewLink.href = '#new-event';
                viewLink.textContent = 'View';

                const checklistButton = document.createElement('button');
                checklistButton.type = 'button';
                checklistButton.className = 'card-action link-button';
                checklistButton.dataset.eventAction = 'checklist';
                checklistButton.dataset.eventId = event.id;
                checklistButton.textContent = 'Checklist';

                const prepButton = document.createElement('button');
                prepButton.type = 'button';
                prepButton.className = 'card-action link-button';
                prepButton.dataset.eventAction = 'prep';
                prepButton.dataset.eventId = event.id;
                prepButton.textContent = 'Prep sheet';

                const removeButton = document.createElement('button');
                removeButton.type = 'button';
                removeButton.className = 'card-action link-button';
                removeButton.dataset.removeEvent = event.id;
                removeButton.textContent = 'Remove';

                actionsCell.appendChild(viewLink);
                actionsCell.appendChild(checklistButton);
                actionsCell.appendChild(prepButton);
                actionsCell.appendChild(removeButton);

                row.appendChild(nameCell);
                row.appendChild(dateCell);
                row.appendChild(locationCell);
                row.appendChild(packageCell);
                row.appendChild(statusCell);
                row.appendChild(staffingCell);
                row.appendChild(actionsCell);
                tableBody.appendChild(row);
            });
        }

        if (tabs.length) {
            tabs.forEach((tab) => {
                tab.addEventListener('click', () => {
                    tabs.forEach((button) => button.classList.remove('active'));
                    tab.classList.add('active');
                    activeFilter = tab.dataset.filter || 'all';
                    renderEvents();
                });
            });
        }

        if (tableBody) {
            tableBody.addEventListener('click', (event) => {
                if (!(event.target instanceof Element)) {
                    return;
                }

                const actionTrigger = event.target.closest('[data-event-action]');
                if (actionTrigger) {
                    event.preventDefault();
                    const action = actionTrigger.dataset.eventAction;
                    const eventId = actionTrigger.dataset.eventId;

                    if (action === 'checklist' || action === 'prep') {
                        openModal(action, eventId);
                    }
                    return;
                }

                const target = event.target.closest('[data-remove-event]');
                if (!target || !store) {
                    return;
                }

                const eventId = target.dataset.removeEvent;
                store.removeEvent(eventId);
                if (activeModal && activeModal.eventId === eventId) {
                    closeModal();
                }
                renderEvents();
            });
        }

        if (modal) {
            modal.addEventListener('click', (event) => {
                if (!(event.target instanceof Element)) {
                    return;
                }

                if (event.target.closest('[data-modal-dismiss]')) {
                    closeModal();
                }
            });
        }

        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape' && modal && modal.classList.contains('is-open')) {
                closeModal();
            }
        });

        if (form && store) {
            form.addEventListener('submit', (event) => {
                event.preventDefault();

                const formData = new FormData(form);
                const statusOption = form.eventStatus.options[form.eventStatus.selectedIndex];
                const staffingOption = form.eventStaffing.options[form.eventStaffing.selectedIndex];

                const eventPayload = {
                    name: (formData.get('name') || '').trim() || 'Untitled event',
                    date: formData.get('date') || '',
                    time: formData.get('time') || '',
                    location: (formData.get('location') || '').trim(),
                    package: formData.get('package') || '',
                    guestCount: Number(formData.get('guestCount') || 0),
                    payout: Number(formData.get('payout') || 0),
                    status: formData.get('status') || 'Draft',
                    statusLevel: statusOption ? statusOption.dataset.level : undefined,
                    staffingStatus: formData.get('staffingStatus') || 'Unassigned',
                    staffingLevel: staffingOption ? staffingOption.dataset.level : undefined,
                    notes: (formData.get('notes') || '').trim(),
                };

                store.addEvent(eventPayload);
                form.reset();
                if (form.eventStatus) {
                    form.eventStatus.value = 'Confirmed';
                }
                if (form.eventStaffing) {
                    form.eventStaffing.value = 'Fully staffed';
                }
                renderEvents();
            });
        }

        renderEvents();
    </script>
    <script src="app.js"></script>
</body>
</html>
