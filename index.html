<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard - Bartending2U</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="styles.css" />
</head>
<body>
    <header class="top-bar">
        <div class="top-bar__inner">
            <div class="brand">
                <img src="IMG_9047.png" alt="Bartending2U logo" />
                <div class="brand__text">
                    <span class="brand__subtitle">Bartending2U</span>
                    <span class="brand__title">Scheduling Suite</span>
                </div>
            </div>

            <button
                class="mobile-nav-toggle"
                id="mobileNavToggle"
                type="button"
                aria-label="Toggle navigation"
                aria-expanded="false"
                data-mobile-nav-toggle
            >
                <span class="mobile-nav-toggle__icon" aria-hidden="true">‚ò∞</span>
                <span class="sr-only">Toggle navigation</span>
            </button>

            <nav class="nav-links" id="primaryNav">
                <a class="nav-link active" href="index.html">Dashboard</a>
                <a class="nav-link" href="events.html">Events</a>
                <a class="nav-link" href="leads.html">Leads</a>
                <a class="nav-link" href="employees.html">Employees</a>
                <a class="nav-link" href="calendar.html">Calendar</a>
                <a class="nav-link" href="settings.html">Settings</a>
            </nav>

            <a class="cta-button" href="events.html">+ New Event</a>
        </div>
    </header>

    <main class="page-content">
        <section class="page-header">
            <div>
                <p class="page-eyebrow">Dashboard</p>
                <h1 class="page-title">Welcome back, John Garcia!</h1>
                <p class="lead-text">Stay ahead of every tasting, private party, and corporate gathering with a real-time pulse on staffing and logistics.</p>
            </div>
            <div class="hero-actions">
                <a class="button primary" href="events.html">Schedule an Event</a>
                <a class="button ghost" href="leads.html">Log a new lead</a>
                <a class="secondary-link" href="calendar.html">Open calendar overview ‚Üí</a>
            </div>
        </section>

        <section id="dashboard-stats" class="card-grid stats-grid" data-subsection="At-a-glance">
            <article class="stat-card">
                <span class="stat-card__label">Total events</span>
                <span class="stat-card__value" id="totalEventsStat">0</span>
                <span class="stat-card__meta success">+2 vs last week</span>
            </article>
            <article class="stat-card">
                <span class="stat-card__label">Team availability</span>
                <span class="stat-card__value" id="teamAvailabilityStat">0 / 0</span>
                <span class="stat-card__meta warning">Live availability updates</span>
            </article>
            <article class="stat-card">
                <span class="stat-card__label">Next event</span>
                <span class="stat-card__value" id="nextEventName" style="font-size:1.6rem;">No events scheduled</span>
                <span class="stat-card__meta" id="nextEventMeta">Add an event to build your schedule.</span>
            </article>
            <article class="stat-card stat-card--interactive">
                <span class="stat-card__label">Action needed</span>
                <button
                    type="button"
                    class="stat-card__action"
                    id="actionNeededTrigger"
                    data-action-needed-trigger
                    aria-haspopup="dialog"
                    aria-controls="actionNeededDrawer"
                >
                    <span class="stat-card__value" id="actionNeededStat">0</span>
                    <span class="stat-card__meta danger" id="actionNeededMeta">Unassigned shifts</span>
                </button>
            </article>
        </section>

        <section class="split-layout">
            <article id="recent-activity" class="content-card" data-subsection="Recent activity">
                <div class="card-header">
                    <div>
                        <h2 class="card-title">Recent activity</h2>
                        <p class="card-subtitle">A running feed of updates across events, staffing, and client requests.</p>
                    </div>
                    <a class="card-action" href="events.html">View all activity ‚Üí</a>
                </div>
                <div class="timeline">
                    <div class="timeline-item">
                        <div class="timeline-item__left">
                            <span class="timeline-icon">‚úÖ</span>
                            <div>
                                <h3 class="person-card__name">Wedding Reception booked</h3>
                                <p class="card-subtitle">Oct 15 ¬∑ The Grand Hall ¬∑ Deposit received</p>
                            </div>
                        </div>
                        <span class="timeline-item__meta">2 minutes ago</span>
                    </div>
                    <div class="timeline-item">
                        <div class="timeline-item__left">
                            <span class="timeline-icon">üë§</span>
                            <div>
                                <h3 class="person-card__name">John Garcia assigned</h3>
                                <p class="card-subtitle">Corporate Party ¬∑ Bar Lead confirmed</p>
                            </div>
                        </div>
                        <span class="timeline-item__meta">1 hour ago</span>
                    </div>
                    <div class="timeline-item">
                        <div class="timeline-item__left">
                            <span class="timeline-icon">üìù</span>
                            <div>
                                <h3 class="person-card__name">Availability updated</h3>
                                <p class="card-subtitle">Jane Smith marked unavailable on Nov 1</p>
                            </div>
                        </div>
                        <span class="timeline-item__meta">4 hours ago</span>
                    </div>
                    <div class="timeline-item">
                        <div class="timeline-item__left">
                            <span class="timeline-icon">üì¶</span>
                            <div>
                                <h3 class="person-card__name">Inventory check</h3>
                                <p class="card-subtitle">Glassware restocked ¬∑ Ready for tasting events</p>
                            </div>
                        </div>
                        <span class="timeline-item__meta">Yesterday</span>
                    </div>
                </div>
                <div class="timeline" id="activityFeed"></div>
            </article>

            <article id="critical-alerts" class="content-card" data-subsection="Critical alerts">
                <div class="card-header">
                    <div>
                        <h2 class="card-title">Critical alerts</h2>
                        <p class="card-subtitle">Proactively resolve staffing risks before they impact guests.</p>
                    </div>
                </div>
                <div class="accordion">
                    <div class="accordion-item">
                        <button class="accordion-trigger" data-accordion-target="alert-1" aria-expanded="true">
                            <span><span class="badge danger">3 shifts</span> Pending staffing</span>
                            <span aria-hidden="true">‚åÑ</span>
                        </button>
                        <div class="accordion-content" id="alert-1" data-open="true">
                            <div class="accordion-content__inner">
                                <ul id="staffingAlertsList" class="alert-list"></ul>
                                <a class="card-action" href="employees.html">Review available team ‚Üí</a>
                            </div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <button class="accordion-trigger" data-accordion-target="alert-2" aria-expanded="false">
                            <span><span class="badge warning">1 client</span> Awaiting confirmation</span>
                            <span aria-hidden="true">‚åÑ</span>
                        </button>
                        <div class="accordion-content" id="alert-2">
                            <div class="accordion-content__inner">
                                <p>The Rivera tasting proposal expires tomorrow. Send the updated signature package to secure the booking.</p>
                                <a class="card-action" href="events.html">Open proposals dashboard ‚Üí</a>
                            </div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <button class="accordion-trigger" data-accordion-target="alert-3" aria-expanded="false">
                            <span><span class="badge success">Supplies</span> Ready for pickup</span>
                            <span aria-hidden="true">‚åÑ</span>
                        </button>
                        <div class="accordion-content" id="alert-3">
                            <div class="accordion-content__inner">
                                <p>Craft syrups prepared for Saturday. Coordinate pickup during Friday load-out.</p>
                                <a class="card-action" href="settings.html">Adjust prep reminders ‚Üí</a>
                            </div>
                        </div>
                    </div>
                </div>
            </article>
        </section>

        <section class="content-card">
            <div class="card-header">
                <div>
                    <h2 class="card-title">This week‚Äôs events</h2>
                    <p class="card-subtitle">A focused look at upcoming commitments and staffing readiness.</p>
                </div>
                <a class="card-action" href="calendar.html">View full calendar ‚Üí</a>
            </div>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>Event</th>
                            <th>Date</th>
                            <th>Location</th>
                            <th>Team</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td data-label="Event">Corporate Party</td>
                            <td data-label="Date">Oct 5, 2025 ¬∑ 7:00 PM</td>
                            <td data-label="Location">Downtown Houston</td>
                            <td data-label="Team">John D., Alex R.</td>
                            <td data-label="Status"><span class="badge success">Ready</span></td>
                            <td class="table-actions" data-label="Actions">
                                <a class="card-action" href="events.html">View details</a>
                            </td>
                        </tr>
                        <tr>
                            <td data-label="Event">Wedding Reception</td>
                            <td data-label="Date">Oct 15, 2025 ¬∑ 6:00 PM</td>
                            <td data-label="Location">The Grand Hall</td>
                            <td data-label="Team">Pending assignments</td>
                            <td data-label="Status"><span class="badge warning">Needs staffing</span></td>
                            <td class="table-actions" data-label="Actions">
                                <a class="card-action" href="employees.html">Assign team</a>
                            </td>
                        </tr>
                        <tr>
                            <td data-label="Event">Mixology Workshop</td>
                            <td data-label="Date">Oct 18, 2025 ¬∑ 5:30 PM</td>
                            <td data-label="Location">Private Residence</td>
                            <td data-label="Team">Jamie L., Priya S.</td>
                            <td data-label="Status"><span class="badge success">Confirmed</span></td>
                            <td class="table-actions" data-label="Actions">
                                <a class="card-action" href="events.html">Manage</a>
                            </td>
                        </tr>
                    </tbody>
                    <tbody id="dashboardEventsTable"></tbody>
                </table>
            </div>
        </section>
        <div class="action-needed-overlay" id="actionNeededOverlay" hidden></div>
        <aside
            class="action-needed-drawer"
            id="actionNeededDrawer"
            role="dialog"
            aria-modal="true"
            aria-hidden="true"
            aria-labelledby="actionNeededTitle"
        >
            <div class="action-needed-drawer__header">
                <h2 class="action-needed-drawer__title" id="actionNeededTitle">Shifts needing staffing</h2>
                <button type="button" class="icon-button" data-action-needed-close aria-label="Close action needed panel">
                    ‚úï
                </button>
            </div>
            <div class="action-needed-drawer__body">
                <p class="action-needed-drawer__intro">
                    Review events that still need staffing coverage and quickly assign available team members.
                </p>
                <div id="actionNeededFeedback" class="action-needed-drawer__feedback" role="status" aria-live="polite"></div>
                <div id="actionNeededEmpty" class="action-needed-empty-state" hidden>
                    All events are fully staffed. Great job!
                </div>
                <div id="actionNeededList" class="action-needed-list"></div>
            </div>
        </aside>
    </main>

    <footer class="app-footer">¬© 2025 Bartending2U. Crafted for seamless event coordination.</footer>

    <script src="scripts.js"></script>
    <script src="storage.js"></script>
    <script>
        const navToggle = document.getElementById('mobileNavToggle');
        const nav = document.getElementById('primaryNav');

        if (navToggle && nav) {
            navToggle.addEventListener('click', () => {
                nav.classList.toggle('open');
            });
        }

        const accordionTriggers = document.querySelectorAll('.accordion-trigger');
        accordionTriggers.forEach((trigger) => {
            const targetId = trigger.getAttribute('data-accordion-target');
            const content = document.getElementById(targetId);
            if (!content) return;

            if (content.dataset.open === 'true') {
                content.style.maxHeight = content.scrollHeight + 'px';
            }

            trigger.addEventListener('click', () => {
                const isExpanded = trigger.getAttribute('aria-expanded') === 'true';
                trigger.setAttribute('aria-expanded', String(!isExpanded));

                if (!isExpanded) {
                    content.style.maxHeight = content.scrollHeight + 'px';
                } else {
                    content.style.maxHeight = '0px';
                }
            });
        });

        const store = window.B2UStore;

        function formatDateTime(dateStr, timeStr) {
            if (!dateStr) {
                return 'Date TBC';
            }

            const safeTime = timeStr ? timeStr : '12:00';
            const date = new Date(`${dateStr}T${safeTime}`);
            const dateFormatter = new Intl.DateTimeFormat('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric',
            });
            const timeFormatter = new Intl.DateTimeFormat('en-US', {
                hour: 'numeric',
                minute: '2-digit',
            });

            return `${dateFormatter.format(date)} ¬∑ ${timeFormatter.format(date)}`;
        }

        function formatDateOnly(dateStr) {
            if (!dateStr) {
                return 'Date TBC';
            }
            const date = new Date(`${dateStr}T12:00`);
            return new Intl.DateTimeFormat('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric',
            }).format(date);
        }

        function formatCurrency(amount) {
            if (!amount && amount !== 0) {
                return '$0';
            }
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                maximumFractionDigits: 0,
            }).format(amount);
        }

        function formatRelativeTime(timestamp) {
            if (!timestamp) {
                return '';
            }

            const diffMs = Date.now() - timestamp;
            const minutes = Math.floor(diffMs / (1000 * 60));
            if (minutes < 1) return 'Just now';
            if (minutes < 60) return `${minutes} min ago`;
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `${hours} hour${hours === 1 ? '' : 's'} ago`;
            const days = Math.floor(hours / 24);
            if (days < 7) return `${days} day${days === 1 ? '' : 's'} ago`;
            return formatDateOnly(new Date(timestamp).toISOString().slice(0, 10));
        }

        function getEventTimestamp(event) {
            if (!event || !event.date) {
                return Number.MAX_SAFE_INTEGER;
            }

            const timestamp = new Date(`${event.date}T${event.time || '00:00'}`).getTime();
            return Number.isNaN(timestamp) ? Number.MAX_SAFE_INTEGER : timestamp;
        }

        function createBadge(text, level) {
            const badge = document.createElement('span');
            badge.className = `badge ${level || 'neutral'}`;
            badge.textContent = text;
            return badge;
        }

        function renderActivity(events, employees) {
            const feed = document.getElementById('activityFeed');
            if (!feed) {
                return;
            }

            feed.innerHTML = '';

            const activityItems = [
                ...events.map((event) => ({
                    id: event.id,
                    createdAt: event.createdAt || 0,
                    icon: 'üç∏',
                    title: `${event.name} saved`,
                    subtitle: `${formatDateTime(event.date, event.time)} ¬∑ ${event.location || 'Location TBC'}`,
                })),
                ...employees.map((employee) => ({
                    id: employee.id,
                    createdAt: employee.createdAt || 0,
                    icon: 'üë§',
                    title: `${employee.name} added`,
                    subtitle: `${employee.role || 'Role pending'} ¬∑ ${employee.status || 'Status pending'}`,
                })),
            ]
                .sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0))
                .slice(0, 6);

            if (activityItems.length === 0) {
                const empty = document.createElement('p');
                empty.className = 'empty-state';
                empty.textContent = 'Activities will appear here after you add events or employees.';
                feed.appendChild(empty);
                return;
            }

            activityItems.forEach((item) => {
                const timelineItem = document.createElement('div');
                timelineItem.className = 'timeline-item';

                const left = document.createElement('div');
                left.className = 'timeline-item__left';

                const icon = document.createElement('span');
                icon.className = 'timeline-icon';
                icon.textContent = item.icon;
                left.appendChild(icon);

                const copy = document.createElement('div');
                const title = document.createElement('h3');
                title.className = 'person-card__name';
                title.textContent = item.title;
                const subtitle = document.createElement('p');
                subtitle.className = 'card-subtitle';
                subtitle.textContent = item.subtitle;
                copy.appendChild(title);
                copy.appendChild(subtitle);
                left.appendChild(copy);

                const meta = document.createElement('span');
                meta.className = 'timeline-item__meta';
                meta.textContent = formatRelativeTime(item.createdAt);

                timelineItem.appendChild(left);
                timelineItem.appendChild(meta);
                feed.appendChild(timelineItem);
            });
        }

        function renderDashboardEvents(events) {
            const tableBody = document.getElementById('dashboardEventsTable');
            if (!tableBody) {
                return;
            }

            tableBody.innerHTML = '';

            if (events.length === 0) {
                const row = document.createElement('tr');
                const cell = document.createElement('td');
                cell.colSpan = 6;
                cell.className = 'empty-state';
                cell.textContent = 'Log your first event to build this view.';
                row.appendChild(cell);
                tableBody.appendChild(row);
                return;
            }

            events.slice(0, 5).forEach((event) => {
                const row = document.createElement('tr');

                const nameCell = document.createElement('td');
                nameCell.textContent = event.name;

                const dateCell = document.createElement('td');
                dateCell.textContent = formatDateTime(event.date, event.time);

                const locationCell = document.createElement('td');
                locationCell.textContent = event.location || 'Location TBC';

                const teamCell = document.createElement('td');
                teamCell.textContent = event.staffingStatus || 'Staffing pending';

                const statusCell = document.createElement('td');
                statusCell.appendChild(createBadge(event.status || 'Pending', event.statusLevel));

                const actionsCell = document.createElement('td');
                actionsCell.className = 'table-actions';
                const link = document.createElement('a');
                link.className = 'card-action';
                link.href = 'events.html';
                link.textContent = 'View details';
                actionsCell.appendChild(link);

                row.appendChild(nameCell);
                row.appendChild(dateCell);
                row.appendChild(locationCell);
                row.appendChild(teamCell);
                row.appendChild(statusCell);
                row.appendChild(actionsCell);
                tableBody.appendChild(row);
            });
        }

        function renderStaffingAlerts(events) {
            const alertsList = document.getElementById('staffingAlertsList');
            if (!alertsList) {
                return;
            }

            alertsList.innerHTML = '';
            const needsAttention = events.filter((event) => event.staffingLevel !== 'success');

            if (needsAttention.length === 0) {
                const item = document.createElement('li');
                item.textContent = 'All events are fully staffed. Great job!';
                alertsList.appendChild(item);
                return;
            }

            needsAttention.forEach((event) => {
                const item = document.createElement('li');
                item.innerHTML = `<strong>${event.name}</strong> ¬∑ ${event.staffingStatus || 'Staffing pending'} ¬∑ ${formatDateOnly(event.date)}`;
                alertsList.appendChild(item);
            });
        }

        function updateStats(events, employees) {
            const totalEvents = document.getElementById('totalEventsStat');
            const teamAvailability = document.getElementById('teamAvailabilityStat');
            const nextEventName = document.getElementById('nextEventName');
            const nextEventMeta = document.getElementById('nextEventMeta');
            const actionNeeded = document.getElementById('actionNeededStat');
            const actionNeededMeta = document.getElementById('actionNeededMeta');

            if (totalEvents) {
                totalEvents.textContent = events.length;
            }

            if (teamAvailability) {
                const available = employees.filter((employee) => employee.statusLevel === 'success').length;
                teamAvailability.textContent = `${available} / ${employees.length}`;
            }

            if (actionNeeded) {
                const needsStaff = events.filter((event) => event.staffingLevel !== 'success').length;
                actionNeeded.textContent = needsStaff;

                if (actionNeededMeta) {
                    actionNeededMeta.textContent =
                        needsStaff === 0
                            ? 'All staffed'
                            : needsStaff === 1
                            ? 'Shift needs staffing'
                            : 'Unassigned shifts';

                    actionNeededMeta.classList.toggle('danger', needsStaff > 0);
                    actionNeededMeta.classList.toggle('success', needsStaff === 0);
                }
            }

            if (nextEventName && nextEventMeta) {
                const upcoming = events
                    .slice()
                    .sort((a, b) => getEventTimestamp(a) - getEventTimestamp(b))
                    .find((event) => getEventTimestamp(event) >= Date.now());

                if (upcoming) {
                    nextEventName.textContent = upcoming.name;
                    nextEventMeta.textContent = `${formatDateTime(upcoming.date, upcoming.time)} ¬∑ ${formatCurrency(upcoming.payout || 0)}`;
                } else if (events.length > 0) {
                    const latest = events
                        .slice()
                        .sort((a, b) => getEventTimestamp(b) - getEventTimestamp(a))[0];
                    nextEventName.textContent = latest.name;
                    nextEventMeta.textContent = `${formatDateTime(latest.date, latest.time)} ¬∑ Completed`;
                } else {
                    nextEventName.textContent = 'No events scheduled';
                    nextEventMeta.textContent = 'Add an event to build your schedule.';
                }
            }
        }

        function renderActionNeededDrawer(events, employees) {
            const list = document.getElementById('actionNeededList');
            const emptyState = document.getElementById('actionNeededEmpty');

            if (!list || !emptyState) {
                return;
            }

            list.innerHTML = '';

            const needsStaff = events.filter((event) => event.staffingLevel !== 'success');
            const availableEmployees = employees.filter((employee) => employee.statusLevel === 'success');

            if (needsStaff.length === 0) {
                emptyState.hidden = false;
                return;
            }

            emptyState.hidden = true;

            needsStaff
                .sort((a, b) => getEventTimestamp(a) - getEventTimestamp(b))
                .forEach((event) => {
                    const card = document.createElement('section');
                    card.className = 'action-needed-item';

                    const header = document.createElement('header');
                    header.className = 'action-needed-item__header';

                    const title = document.createElement('h3');
                    title.className = 'action-needed-item__title';
                    title.textContent = event.name;

                    const date = document.createElement('p');
                    date.className = 'action-needed-item__date';
                    date.textContent = formatDateTime(event.date, event.time);

                    header.appendChild(title);
                    header.appendChild(date);
                    card.appendChild(header);

                    const status = document.createElement('p');
                    status.className = 'action-needed-item__status';
                    status.textContent = event.staffingStatus || 'Staffing pending';
                    card.appendChild(status);

                    const assignedNames = Array.isArray(event.assignedTeam)
                        ? event.assignedTeam
                              .map((id) => {
                                  const match = employees.find((employee) => employee.id === id);
                                  return match ? match.name : null;
                              })
                              .filter(Boolean)
                        : [];

                    if (assignedNames.length > 0) {
                        const assigned = document.createElement('p');
                        assigned.className = 'action-needed-item__assigned';
                        assigned.textContent = `Currently assigned: ${assignedNames.join(', ')}`;
                        card.appendChild(assigned);
                    }

                    const form = document.createElement('form');
                    form.className = 'action-needed-form';
                    form.dataset.eventId = event.id;

                    const description = document.createElement('p');
                    description.className = 'action-needed-form__help';
                    description.textContent = 'Assign available team members to cover this event.';
                    form.appendChild(description);

                    if (availableEmployees.length === 0) {
                        const noTeam = document.createElement('p');
                        noTeam.className = 'action-needed-form__empty';
                        noTeam.textContent = 'No team members are currently available. Update availability in the Employees tab.';
                        form.appendChild(noTeam);
                    } else {
                        const checklist = document.createElement('div');
                        checklist.className = 'action-needed-form__checklist';

                        availableEmployees.forEach((employee) => {
                            const wrapper = document.createElement('label');
                            wrapper.className = 'action-needed-form__option';

                            const input = document.createElement('input');
                            input.type = 'checkbox';
                            input.name = `assignment-${event.id}`;
                            input.value = employee.id;
                            input.checked = Array.isArray(event.assignedTeam) && event.assignedTeam.includes(employee.id);

                            const span = document.createElement('span');
                            span.innerHTML = `<strong>${employee.name}</strong><small>${employee.role}</small>`;

                            wrapper.appendChild(input);
                            wrapper.appendChild(span);
                            checklist.appendChild(wrapper);
                        });

                        form.appendChild(checklist);
                    }

                    const actions = document.createElement('div');
                    actions.className = 'action-needed-form__actions';

                    const submit = document.createElement('button');
                    submit.type = 'submit';
                    submit.className = 'button primary';
                    submit.textContent = 'Assign selected team';
                    submit.disabled = availableEmployees.length === 0;

                    actions.appendChild(submit);
                    form.appendChild(actions);
                    card.appendChild(form);
                    list.appendChild(card);

                });
        }

        function attachActionNeededHandlers(state) {
            const trigger = document.querySelector('[data-action-needed-trigger]');
            const drawer = document.getElementById('actionNeededDrawer');
            const overlay = document.getElementById('actionNeededOverlay');
            const closeButton = document.querySelector('[data-action-needed-close]');
            const feedback = document.getElementById('actionNeededFeedback');

            if (!trigger || !drawer) {
                return;
            }

            const focusableSelectors = 'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])';
            let lastFocusedElement = null;

            const setOpenState = (isOpen) => {
                drawer.classList.toggle('open', isOpen);
                drawer.setAttribute('aria-hidden', String(!isOpen));

                if (overlay) {
                    overlay.hidden = !isOpen;
                    overlay.classList.toggle('open', isOpen);
                }

                document.body.classList.toggle('drawer-open', isOpen);

                if (isOpen) {
                    const focusable = drawer.querySelectorAll(focusableSelectors);
                    if (focusable.length > 0) {
                        focusable[0].focus();
                    }
                } else if (lastFocusedElement) {
                    lastFocusedElement.focus();
                    lastFocusedElement = null;
                }
            };

            const openDrawer = () => {
                lastFocusedElement = document.activeElement instanceof HTMLElement ? document.activeElement : null;
                if (feedback) {
                    feedback.textContent = '';
                }
                renderActionNeededDrawer(state.events, state.employees);
                setOpenState(true);
            };

            const closeDrawer = () => {
                setOpenState(false);
            };

            trigger.addEventListener('click', () => {
                if (trigger.disabled) {
                    return;
                }
                openDrawer();
            });

            if (overlay) {
                overlay.addEventListener('click', closeDrawer);
            }

            if (closeButton) {
                closeButton.addEventListener('click', closeDrawer);
            }

            document.addEventListener('keydown', (event) => {
                if (event.key === 'Escape' && drawer.classList.contains('open')) {
                    closeDrawer();
                }
            });

            document.addEventListener('submit', (event) => {
                const form = event.target;
                if (!(form instanceof HTMLFormElement)) {
                    return;
                }

                if (!form.classList.contains('action-needed-form')) {
                    return;
                }

                event.preventDefault();
                const eventId = form.dataset.eventId;
                if (!eventId) {
                    return;
                }

                const checked = Array.from(form.querySelectorAll('input[type="checkbox"]:checked'));
                const selectedIds = checked.map((input) => input.value);

                const assignedNames = state.employees
                    .filter((employee) => selectedIds.includes(employee.id))
                    .map((employee) => employee.name);

                const staffingStatus = assignedNames.length
                    ? `Assigned team: ${assignedNames.join(', ')}`
                    : 'Staffing pending';
                const staffingLevel = assignedNames.length ? 'success' : 'warning';

                store.updateEvent(eventId, {
                    assignedTeam: selectedIds,
                    staffingStatus,
                    staffingLevel,
                });

                state.events = store.getEvents();
                state.employees = store.getEmployees();

                renderActivity(state.events, state.employees);
                renderDashboardEvents(
                    state.events
                        .slice()
                        .sort((a, b) => getEventTimestamp(a) - getEventTimestamp(b))
                );
                renderStaffingAlerts(state.events);
                updateStats(state.events, state.employees);
                renderActionNeededDrawer(state.events, state.employees);

                if (feedback) {
                    const updatedEvent = state.events.find((item) => item.id === eventId);
                    feedback.textContent = assignedNames.length
                        ? `${updatedEvent ? updatedEvent.name : 'Event'} now has ${assignedNames.length} team member${assignedNames.length === 1 ? '' : 's'} assigned.`
                        : 'Assignment removed. This event still needs staffing.';
                }
            });
        }

        if (store) {
            const state = {
                events: store.getEvents(),
                employees: store.getEmployees(),
            };

            renderActivity(state.events, state.employees);
            renderDashboardEvents(
                state.events
                    .slice()
                    .sort((a, b) => getEventTimestamp(a) - getEventTimestamp(b))
            );
            renderStaffingAlerts(state.events);
            updateStats(state.events, state.employees);
            renderActionNeededDrawer(state.events, state.employees);
            attachActionNeededHandlers(state);
        }
    </script>
    <script src="app.js"></script>
</body>
</html>
