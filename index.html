<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard - Bartending2U</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="styles.css" />
</head>
<body>
    <header class="top-bar">
        <div class="top-bar__inner">
            <div class="brand">
                <img src="IMG_9047.png" alt="Bartending2U logo" />
                <div class="brand__text">
                    <span class="brand__subtitle">Bartending2U</span>
                    <span class="brand__title">Scheduling Suite</span>
                </div>
            </div>

            <button
                class="mobile-nav-toggle"
                id="mobileNavToggle"
                type="button"
                aria-label="Toggle navigation"
                aria-expanded="false"
                data-mobile-nav-toggle
            >
                <span class="mobile-nav-toggle__icon" aria-hidden="true">☰</span>
                <span class="sr-only">Toggle navigation</span>
            </button>

            <nav class="nav-links" id="primaryNav">
                <a class="nav-link active" href="index.html">Dashboard</a>
                <a class="nav-link" href="events.html">Events</a>
                <a class="nav-link" href="employees.html">Employees</a>
                <a class="nav-link" href="calendar.html">Calendar</a>
                <a class="nav-link" href="settings.html">Settings</a>
            </nav>

            <a class="cta-button" href="events.html">+ New Event</a>
        </div>
    </header>

    <main class="page-content">
        <section class="page-header">
            <div>
                <p class="page-eyebrow">Dashboard</p>
                <h1 class="page-title">Welcome back, Admin!</h1>
                <p class="lead-text">Keep tabs on staffing and logistics for every upcoming event.</p>
            </div>
            <div class="hero-actions">
                <a class="button primary" href="events.html">Schedule an Event</a>
                <a class="secondary-link" href="calendar.html">Open calendar overview →</a>
            </div>
        </section>

        <section id="dashboard-stats" class="card-grid stats-grid" data-subsection="At-a-glance">
            <article class="stat-card">
                <span class="stat-card__label">Total events</span>
                <span class="stat-card__value" id="totalEventsStat">0</span>
                <span class="stat-card__meta success">+2 vs last week</span>
            </article>
            <article class="stat-card">
                <span class="stat-card__label">Team availability</span>
                <span class="stat-card__value" id="teamAvailabilityStat">0 / 0</span>
                <span class="stat-card__meta warning">Live availability updates</span>
            </article>
            <article class="stat-card">
                <span class="stat-card__label">Next event</span>
                <span class="stat-card__value" id="nextEventName" style="font-size:1.6rem;">No events scheduled</span>
                <span class="stat-card__meta" id="nextEventMeta">Add an event to build your schedule.</span>
            </article>
            <article class="stat-card">
                <span class="stat-card__label">Action needed</span>
                <span class="stat-card__value" id="actionNeededStat" style="color: var(--danger-500);">0</span>
                <span class="stat-card__meta danger">Unassigned shifts</span>
            </article>
        </section>

        <section class="split-layout">
            <article id="recent-activity" class="content-card" data-subsection="Recent activity">
                <div class="card-header">
                    <div>
                        <h2 class="card-title">Recent activity</h2>
                        <p class="card-subtitle">A running feed of updates across events, staffing, and client requests.</p>
                    </div>
                    <a class="card-action" href="events.html">View all activity →</a>
                </div>
                <div class="timeline" id="activityFeed"></div>
            </article>

            <article id="critical-alerts" class="content-card" data-subsection="Critical alerts">
                <div class="card-header">
                    <div>
                        <h2 class="card-title">Critical alerts</h2>
                        <p class="card-subtitle">Proactively resolve staffing risks before they impact guests.</p>
                    </div>
                </div>
                <div class="accordion">
                    <div class="accordion-item">
                        <button class="accordion-trigger" data-accordion-target="alert-1" aria-expanded="true">
                            <span><span class="badge danger">3 shifts</span> Pending staffing</span>
                            <span aria-hidden="true">⌄</span>
                        </button>
                        <div class="accordion-content" id="alert-1" data-open="true">
                            <div class="accordion-content__inner">
                                <ul id="staffingAlertsList" class="alert-list"></ul>
                                <a class="card-action" href="employees.html">Review available team →</a>
                            </div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <button class="accordion-trigger" data-accordion-target="alert-2" aria-expanded="false">
                            <span><span class="badge warning">1 client</span> Awaiting confirmation</span>
                            <span aria-hidden="true">⌄</span>
                        </button>
                        <div class="accordion-content" id="alert-2">
                            <div class="accordion-content__inner">
                                <p>The Rivera tasting proposal expires tomorrow. Send the updated signature package to secure the booking.</p>
                                <a class="card-action" href="events.html">Open proposals dashboard →</a>
                            </div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <button class="accordion-trigger" data-accordion-target="alert-3" aria-expanded="false">
                            <span><span class="badge success">Supplies</span> Ready for pickup</span>
                            <span aria-hidden="true">⌄</span>
                        </button>
                        <div class="accordion-content" id="alert-3">
                            <div class="accordion-content__inner">
                                <p>Craft syrups prepared for Saturday. Coordinate pickup during Friday load-out.</p>
                                <a class="card-action" href="settings.html">Adjust prep reminders →</a>
                            </div>
                        </div>
                    </div>
                </div>
            </article>
        </section>

        <section class="content-card">
            <div class="card-header">
                <div>
                    <h2 class="card-title">This week’s events</h2>
                    <p class="card-subtitle">A focused look at upcoming commitments and staffing readiness.</p>
                </div>
                <a class="card-action" href="calendar.html">View full calendar →</a>
            </div>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>Event</th>
                            <th>Date</th>
                            <th>Location</th>
                            <th>Team</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td data-label="Event">Corporate Party</td>
                            <td data-label="Date">Oct 5, 2025 · 7:00 PM</td>
                            <td data-label="Location">Downtown Houston</td>
                            <td data-label="Team">John D., Alex R.</td>
                            <td data-label="Status"><span class="badge success">Ready</span></td>
                            <td class="table-actions" data-label="Actions">
                                <a class="card-action" href="events.html">View details</a>
                            </td>
                        </tr>
                        <tr>
                            <td data-label="Event">Wedding Reception</td>
                            <td data-label="Date">Oct 15, 2025 · 6:00 PM</td>
                            <td data-label="Location">The Grand Hall</td>
                            <td data-label="Team">Pending assignments</td>
                            <td data-label="Status"><span class="badge warning">Needs staffing</span></td>
                            <td class="table-actions" data-label="Actions">
                                <a class="card-action" href="employees.html">Assign team</a>
                            </td>
                        </tr>
                        <tr>
                            <td data-label="Event">Mixology Workshop</td>
                            <td data-label="Date">Oct 18, 2025 · 5:30 PM</td>
                            <td data-label="Location">Private Residence</td>
                            <td data-label="Team">Jamie L., Priya S.</td>
                            <td data-label="Status"><span class="badge success">Confirmed</span></td>
                            <td class="table-actions" data-label="Actions">
                                <a class="card-action" href="events.html">Manage</a>
                            </td>
                        </tr>
                    </tbody>
                    <tbody id="dashboardEventsTable"></tbody>
                </table>
            </div>
        </section>
    </main>

    <footer class="app-footer">© 2025 Bartending2U. Crafted for seamless event coordination.</footer>

    <script src="scripts.js"></script>
    <script src="storage.js"></script>
    <script>
        const navToggle = document.getElementById('mobileNavToggle');
        const nav = document.getElementById('primaryNav');

        if (navToggle && nav) {
            navToggle.addEventListener('click', () => {
                nav.classList.toggle('open');
            });
        }

        const accordionTriggers = document.querySelectorAll('.accordion-trigger');
        accordionTriggers.forEach((trigger) => {
            const targetId = trigger.getAttribute('data-accordion-target');
            const content = document.getElementById(targetId);
            if (!content) return;

            if (content.dataset.open === 'true') {
                content.style.maxHeight = content.scrollHeight + 'px';
            }

            trigger.addEventListener('click', () => {
                const isExpanded = trigger.getAttribute('aria-expanded') === 'true';
                trigger.setAttribute('aria-expanded', String(!isExpanded));

                if (!isExpanded) {
                    content.style.maxHeight = content.scrollHeight + 'px';
                } else {
                    content.style.maxHeight = '0px';
                }
            });
        });

        const store = window.B2UStore;

        function formatDateTime(dateStr, timeStr) {
            if (!dateStr) {
                return 'Date TBC';
            }

            const safeTime = timeStr ? timeStr : '12:00';
            const date = new Date(`${dateStr}T${safeTime}`);
            const dateFormatter = new Intl.DateTimeFormat('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric',
            });
            const timeFormatter = new Intl.DateTimeFormat('en-US', {
                hour: 'numeric',
                minute: '2-digit',
            });

            return `${dateFormatter.format(date)} · ${timeFormatter.format(date)}`;
        }

        function formatDateOnly(dateStr) {
            if (!dateStr) {
                return 'Date TBC';
            }
            const date = new Date(`${dateStr}T12:00`);
            return new Intl.DateTimeFormat('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric',
            }).format(date);
        }

        function formatCurrency(amount) {
            if (!amount && amount !== 0) {
                return '$0';
            }
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                maximumFractionDigits: 0,
            }).format(amount);
        }

        function formatRelativeTime(timestamp) {
            if (!timestamp) {
                return '';
            }

            const diffMs = Date.now() - timestamp;
            const minutes = Math.floor(diffMs / (1000 * 60));
            if (minutes < 1) return 'Just now';
            if (minutes < 60) return `${minutes} min ago`;
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `${hours} hour${hours === 1 ? '' : 's'} ago`;
            const days = Math.floor(hours / 24);
            if (days < 7) return `${days} day${days === 1 ? '' : 's'} ago`;
            return formatDateOnly(new Date(timestamp).toISOString().slice(0, 10));
        }

        function getEventTimestamp(event) {
            if (!event || !event.date) {
                return Number.MAX_SAFE_INTEGER;
            }

            const timestamp = new Date(`${event.date}T${event.time || '00:00'}`).getTime();
            return Number.isNaN(timestamp) ? Number.MAX_SAFE_INTEGER : timestamp;
        }

        function createBadge(text, level) {
            const badge = document.createElement('span');
            badge.className = `badge ${level || 'neutral'}`;
            badge.textContent = text;
            return badge;
        }

        function renderActivity(events, employees) {
            const feed = document.getElementById('activityFeed');
            if (!feed) {
                return;
            }

            feed.innerHTML = '';

            const activityItems = [
                ...events.map((event) => ({
                    id: event.id,
                    createdAt: event.createdAt || 0,
                    icon: '🍸',
                    title: `${event.name} saved`,
                    subtitle: `${formatDateTime(event.date, event.time)} · ${event.location || 'Location TBC'}`,
                })),
                ...employees.map((employee) => ({
                    id: employee.id,
                    createdAt: employee.createdAt || 0,
                    icon: '👤',
                    title: `${employee.name} added`,
                    subtitle: `${employee.role || 'Role pending'} · ${employee.status || 'Status pending'}`,
                })),
            ]
                .sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0))
                .slice(0, 6);

            if (activityItems.length === 0) {
                const empty = document.createElement('p');
                empty.className = 'empty-state';
                empty.textContent = 'Activities will appear here after you add events or employees.';
                feed.appendChild(empty);
                return;
            }

            activityItems.forEach((item) => {
                const timelineItem = document.createElement('div');
                timelineItem.className = 'timeline-item';

                const left = document.createElement('div');
                left.className = 'timeline-item__left';

                const icon = document.createElement('span');
                icon.className = 'timeline-icon';
                icon.textContent = item.icon;
                left.appendChild(icon);

                const copy = document.createElement('div');
                const title = document.createElement('h3');
                title.className = 'person-card__name';
                title.textContent = item.title;
                const subtitle = document.createElement('p');
                subtitle.className = 'card-subtitle';
                subtitle.textContent = item.subtitle;
                copy.appendChild(title);
                copy.appendChild(subtitle);
                left.appendChild(copy);

                const meta = document.createElement('span');
                meta.className = 'timeline-item__meta';
                meta.textContent = formatRelativeTime(item.createdAt);

                timelineItem.appendChild(left);
                timelineItem.appendChild(meta);
                feed.appendChild(timelineItem);
            });
        }

        function renderDashboardEvents(events) {
            const tableBody = document.getElementById('dashboardEventsTable');
            if (!tableBody) {
                return;
            }

            tableBody.innerHTML = '';

            if (events.length === 0) {
                const row = document.createElement('tr');
                const cell = document.createElement('td');
                cell.colSpan = 6;
                cell.className = 'empty-state';
                cell.textContent = 'Log your first event to build this view.';
                row.appendChild(cell);
                tableBody.appendChild(row);
                return;
            }

            events.slice(0, 5).forEach((event) => {
                const row = document.createElement('tr');

                const nameCell = document.createElement('td');
                nameCell.textContent = event.name;

                const dateCell = document.createElement('td');
                dateCell.textContent = formatDateTime(event.date, event.time);

                const locationCell = document.createElement('td');
                locationCell.textContent = event.location || 'Location TBC';

                const teamCell = document.createElement('td');
                teamCell.textContent = event.staffingStatus || 'Staffing pending';

                const statusCell = document.createElement('td');
                statusCell.appendChild(createBadge(event.status || 'Pending', event.statusLevel));

                const actionsCell = document.createElement('td');
                actionsCell.className = 'table-actions';
                const link = document.createElement('a');
                link.className = 'card-action';
                link.href = 'events.html';
                link.textContent = 'View details';
                actionsCell.appendChild(link);

                row.appendChild(nameCell);
                row.appendChild(dateCell);
                row.appendChild(locationCell);
                row.appendChild(teamCell);
                row.appendChild(statusCell);
                row.appendChild(actionsCell);
                tableBody.appendChild(row);
            });
        }

        function renderStaffingAlerts(events) {
            const alertsList = document.getElementById('staffingAlertsList');
            if (!alertsList) {
                return;
            }

            alertsList.innerHTML = '';
            const needsAttention = events.filter((event) => event.staffingLevel !== 'success');

            if (needsAttention.length === 0) {
                const item = document.createElement('li');
                item.textContent = 'All events are fully staffed. Great job!';
                alertsList.appendChild(item);
                return;
            }

            needsAttention.forEach((event) => {
                const item = document.createElement('li');
                item.innerHTML = `<strong>${event.name}</strong> · ${event.staffingStatus || 'Staffing pending'} · ${formatDateOnly(event.date)}`;
                alertsList.appendChild(item);
            });
        }

        function updateStats(events, employees) {
            const totalEvents = document.getElementById('totalEventsStat');
            const teamAvailability = document.getElementById('teamAvailabilityStat');
            const nextEventName = document.getElementById('nextEventName');
            const nextEventMeta = document.getElementById('nextEventMeta');
            const actionNeeded = document.getElementById('actionNeededStat');

            if (totalEvents) {
                totalEvents.textContent = events.length;
            }

            if (teamAvailability) {
                const available = employees.filter((employee) => employee.statusLevel === 'success').length;
                teamAvailability.textContent = `${available} / ${employees.length}`;
            }

            if (actionNeeded) {
                const needsStaff = events.filter((event) => event.staffingLevel !== 'success').length;
                actionNeeded.textContent = needsStaff;
            }

            if (nextEventName && nextEventMeta) {
                const upcoming = events
                    .slice()
                    .sort((a, b) => getEventTimestamp(a) - getEventTimestamp(b))
                    .find((event) => getEventTimestamp(event) >= Date.now());

                if (upcoming) {
                    nextEventName.textContent = upcoming.name;
                    nextEventMeta.textContent = `${formatDateTime(upcoming.date, upcoming.time)} · ${formatCurrency(upcoming.payout || 0)}`;
                } else if (events.length > 0) {
                    const latest = events
                        .slice()
                        .sort((a, b) => getEventTimestamp(b) - getEventTimestamp(a))[0];
                    nextEventName.textContent = latest.name;
                    nextEventMeta.textContent = `${formatDateTime(latest.date, latest.time)} · Completed`;
                } else {
                    nextEventName.textContent = 'No events scheduled';
                    nextEventMeta.textContent = 'Add an event to build your schedule.';
                }
            }
        }

        if (store) {
            const events = store.getEvents();
            const employees = store.getEmployees();
            renderActivity(events, employees);
            renderDashboardEvents(
                events
                    .slice()
                    .sort((a, b) => getEventTimestamp(a) - getEventTimestamp(b))
            );
            renderStaffingAlerts(events);
            updateStats(events, employees);
        }
    </script>
    <script src="app.js"></script>
</body>
</html>
